<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Finanzas VE</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Estilos para la tabla P&L */
        .pnl-table-container { overflow-x: auto; position: relative; }
        .pnl-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.75rem; }
        .pnl-cell { padding: 8px 12px; white-space: nowrap; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #f3f4f6; text-align: right; }
        .pnl-cell-head { font-weight: bold; background-color: #f9fafb; position: sticky; top: 0; z-index: 10; text-align: center; border-bottom: 2px solid #e5e7eb; }
        .pnl-col-sticky { position: sticky; left: 0; background-color: white; z-index: 20; border-right: 2px solid #e5e7eb; text-align: left; min-width: 120px; }
        .pnl-col-sticky.pnl-cell-head { z-index: 30; } 
        .pnl-row-group-header { background-color: #f3f4f6; font-weight: bold; color: #374151; }
        .pnl-row-total { background-color: #fdfbf7; font-weight: bold; }
        .pnl-row-net { background-color: #ecfdf5; font-weight: 800; color: #047857; }
        
        /* Animaci칩n suave para IA */
        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 0 0px rgba(168, 85, 247, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(168, 85, 247, 0); }
        }
        .animate-pulse-purple { animation: pulse-purple 2s infinite; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans overflow-hidden">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wallet, TrendingUp, TrendingDown, Plus, Settings, 
            Calendar, DollarSign, RefreshCw, X, Save, ArrowRightLeft,
            LogOut, ChevronDown, Filter, Home, History, PieChart, Trash2, List, FileSpreadsheet, Sparkles, BrainCircuit
        } from 'lucide-react';

        // --- FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy, limit, addDoc, deleteDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURACI칍N DIN츼MICA
        let firebaseConfig;
        let appId;

        if (typeof __firebase_config !== 'undefined') {
            // Entorno de desarrollo (Gemini)
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } else {
            // Entorno Producci칩n (Tus datos reales de la captura)
            firebaseConfig = {
                apiKey: "AIzaSyBzbIz_VKis6nu1W7JWWeCSgLzBqJQ8HzY",
                authDomain: "magapp-19035.firebaseapp.com",
                projectId: "magapp-19035",
                storageBucket: "magapp-19035.firebasestorage.app",
                messagingSenderId: "1022326629606",
                appId: "1:1022326629606:web:ebea8e95dd233bc6560727"
            };
            // Usamos un ID fijo para organizar tus datos dentro de tu base de datos
            appId = 'finanzas-ve-app';
        }

        // Inicializar Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Error inicializando Firebase:", error);
        }

        // --- GEMINI API ---
        const callGemini = async (prompt) => {
            const apiKey = ""; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('Error en la API de Gemini');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) { return null; }
        };

        // --- CONSTANTES ---
        const DEFAULT_PNL = {
            ingresos: ["Sueldo", "Honorarios", "Ventas", "Cambio Divisas"],
            gastos_fijos: ["Alquiler", "Internet", "Condominio", "Colegio", "Suscripciones"],
            gastos_variables: ["Mercado", "Salidas", "Salud", "Transporte", "Gustos"],
            ahorro: ["Ahorro General"]
        };

        const SEGMENTS = {
            ingresos: { label: "Ingresos", color: "text-emerald-600", bg: "bg-emerald-100", type: "income" },
            ahorro: { label: "Ahorro", color: "text-blue-600", bg: "bg-blue-100", type: "expense" },
            gastos_fijos: { label: "Gastos Fijos", color: "text-orange-600", bg: "bg-orange-100", type: "expense" },
            gastos_variables: { label: "Gastos Variables", color: "text-rose-600", bg: "bg-rose-100", type: "expense" }
        };

        // --- COMPONENTES UI ---

        const Card = ({ children, className = "" }) => (
            React.createElement('div', { className: `bg-white p-5 rounded-2xl shadow-sm border border-gray-100 ${className}` }, children)
        );

        const Button = ({ children, onClick, variant = 'primary', className = '', type="button", disabled = false }) => {
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-md shadow-emerald-200",
                secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
                ghost: "text-gray-500 hover:bg-gray-100",
                indigo: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-md shadow-indigo-200",
                magic: "bg-gradient-to-r from-purple-500 to-indigo-600 text-white hover:from-purple-600 hover:to-indigo-700 shadow-md shadow-purple-200"
            };
            return React.createElement('button', { 
                onClick, type, disabled,
                className: `px-4 py-3 rounded-xl font-medium transition-transform active:scale-95 flex items-center justify-center gap-2 w-full ${variants[variant]} ${className} ${disabled ? 'opacity-50' : ''}`
            }, children);
        };

        // --- PANTALLAS ---

        const LoginScreen = () => {
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            
            useEffect(() => {
                const autoAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        setLoading(true);
                        try { await signInWithCustomToken(auth, __initial_auth_token); } 
                        catch (e) { console.error(e); setLoading(false); }
                    }
                };
                if(auth) autoAuth();
            }, []);

            const handleLogin = async () => {
                setLoading(true);
                setErrorMsg(null);
                try {
                    if (!auth) throw new Error("Firebase no inicializado.");
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Login error:", error);
                    setLoading(false);
                    if (error.code === 'auth/admin-restricted-operation') {
                        setErrorMsg("丘멆잺 Error: Habilita el 'Inicio de sesi칩n an칩nimo' en Firebase Console > Authentication.");
                    } else if (error.code === 'auth/api-key-not-valid.-please-pass-a-valid-api-key.') {
                         setErrorMsg("丘멆잺 Error: API Key no v치lida.");
                    } else {
                        setErrorMsg("Error: " + error.message);
                    }
                }
            };

            return React.createElement('div', { className: "h-screen flex flex-col items-center justify-center p-6 bg-emerald-50" },
                React.createElement('div', { className: "bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center" },
                    React.createElement('div', { className: "w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-600" },
                        React.createElement(Wallet, { size: 40 })
                    ),
                    React.createElement('h1', { className: "text-3xl font-bold text-gray-800 mb-2" }, "Finanzas VE"),
                    React.createElement('p', { className: "text-gray-500 mb-8" }, "Tu P&L Personalizado en Venezuela."),
                    
                    errorMsg && React.createElement('div', { className: "mb-4 p-3 bg-red-50 text-red-600 text-xs rounded-xl border border-red-100 text-left font-medium" }, errorMsg),

                    React.createElement(Button, { onClick: handleLogin, disabled: loading }, 
                        loading ? "Entrando..." : "Comenzar"
                    )
                )
            );
        };

        // ... (Resto de componentes PnLConfigModal, AddTransactionModal, RatesCard, HomeView, HistoryView, PnLReportView se mantienen igual)
        // Incluyo aqu칤 las definiciones clave para que el archivo sea aut칩nomo.
        
        const PnLConfigModal = ({ onClose, pnlData, onUpdatePnl }) => {
            const [localPnl, setLocalPnl] = useState(pnlData);
            const [newConcept, setNewConcept] = useState("");
            const [activeSegment, setActiveSegment] = useState("ingresos"); 
            const handleAdd = () => { if (!newConcept.trim()) return; const updatedList = [...(localPnl[activeSegment] || []), newConcept.trim()]; setLocalPnl({ ...localPnl, [activeSegment]: updatedList }); setNewConcept(""); };
            const handleDelete = (segment, index) => { const updatedList = localPnl[segment].filter((_, i) => i !== index); setLocalPnl({ ...localPnl, [segment]: updatedList }); };
            const handleSave = () => { onUpdatePnl(localPnl); onClose(); };
            return React.createElement('div', { className: "fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center animate-in fade-in" },
                React.createElement('div', { className: "bg-white w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl h-[90vh] sm:h-[80vh] flex flex-col" },
                    React.createElement('div', { className: "flex justify-between items-center mb-4" },
                        React.createElement('h2', { className: "text-xl font-bold flex items-center gap-2" }, React.createElement(List, { size: 24, className: "text-indigo-600" }), "Configurar P&L"),
                        React.createElement('button', { onClick: onClose, className: "p-2 bg-gray-100 rounded-full" }, React.createElement(X, { size: 20 }))
                    ),
                    React.createElement('div', { className: "flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide" },
                        ["ingresos", "gastos_fijos", "gastos_variables"].map(seg => React.createElement('button', { key: seg, onClick: () => setActiveSegment(seg), className: `px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${activeSegment === seg ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'}` }, SEGMENTS[seg].label))
                    ),
                    React.createElement('div', { className: "bg-indigo-50 p-4 rounded-xl mb-4" },
                        React.createElement('p', { className: "text-xs text-indigo-500 font-bold uppercase mb-2" }, `Agregar a ${SEGMENTS[activeSegment].label}`),
                        React.createElement('div', { className: "flex gap-2" },
                            React.createElement('input', { value: newConcept, onChange: (e) => setNewConcept(e.target.value), placeholder: "Nuevo concepto...", className: "flex-1 p-2 rounded-lg border border-indigo-200 focus:outline-none focus:border-indigo-500" }),
                            React.createElement('button', { onClick: handleAdd, className: "bg-indigo-600 text-white p-2 rounded-lg" }, React.createElement(Plus, { size: 20 }))
                        )
                    ),
                    React.createElement('div', { className: "flex-1 overflow-y-auto space-y-2 pr-1" },
                        (localPnl[activeSegment] || []).map((concept, idx) => React.createElement('div', { key: idx, className: "flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100" }, React.createElement('span', { className: "font-medium text-gray-700" }, concept), React.createElement('button', { onClick: () => handleDelete(activeSegment, idx), className: "text-red-400 hover:text-red-600 p-1" }, React.createElement(Trash2, { size: 16 }))))
                    ),
                    React.createElement('div', { className: "pt-4 border-t border-gray-100 mt-4" }, React.createElement('p', { className: "text-xs text-gray-400 text-center mb-3" }, "Nota: El segmento 'Ahorro' es fijo."), React.createElement(Button, { onClick: handleSave, variant: "indigo" }, "Guardar Estructura"))
                )
            );
        };

        const AddTransactionModal = ({ onClose, rates, userId, pnlStructure }) => {
            const [segment, setSegment] = useState('gastos_variables'); 
            const [amount, setAmount] = useState('');
            const [currency, setCurrency] = useState('VES');
            const [category, setCategory] = useState('');
            const [description, setDescription] = useState('');
            const [rateType, setRateType] = useState('bcv');
            const [customRate, setCustomRate] = useState(rates.bcv || 0);
            const [magicInput, setMagicInput] = useState('');
            const [isThinking, setIsThinking] = useState(false);

            useEffect(() => {
                const concepts = pnlStructure[segment] || [];
                if (concepts.length > 0 && !category) setCategory(concepts[0]);
                else setCategory("");
            }, [segment, pnlStructure]);

            const handleMagicFill = async () => {
                if(!magicInput.trim()) return;
                setIsThinking(true);
                const allCategories = [];
                Object.keys(pnlStructure).forEach(seg => { (pnlStructure[seg] || []).forEach(cat => allCategories.push(`${cat} (${seg})`)); });
                const prompt = `Act칰a como un asistente contable venezolano. Analiza: "${magicInput}". Devuelve JSON: {amount: number, currency: "VES"|"USD", description: string, category_match: string de [${allCategories.join(", ")}], segment: string}.`;
                try {
                    const response = await callGemini(prompt);
                    const cleanJson = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(cleanJson);
                    if(data.amount) setAmount(data.amount.toString());
                    if(data.currency) setCurrency(data.currency);
                    if(data.description) setDescription(data.description);
                    if(data.segment && SEGMENTS[data.segment]) setSegment(data.segment);
                    setTimeout(() => { if(data.category_match) { const cleanCat = data.category_match.split(' (')[0]; setCategory(cleanCat); } }, 100);
                } catch (e) { alert("No pude entender el gasto."); } finally { setIsThinking(false); }
            };

            const calculatedUSD = useMemo(() => {
                if (!amount) return 0;
                if (currency === 'USD') return parseFloat(amount);
                let rate = 1;
                if (rateType === 'bcv') rate = rates.bcv;
                else if (rateType === 'parallel') rate = rates.parallel;
                else rate = customRate;
                if (!rate || rate === 0) return 0;
                return parseFloat(amount) / rate;
            }, [amount, currency, rateType, customRate, rates]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!amount || !category) return;
                const finalRate = currency === 'USD' ? 1 : (rateType === 'bcv' ? rates.bcv : (rateType === 'parallel' ? rates.parallel : customRate));
                const type = SEGMENTS[segment].type;
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'transactions'), { type, segment, amount: parseFloat(amount), currency, originalRate: parseFloat(finalRate), amountUSD: calculatedUSD, category, description, date: new Date().toISOString() });
                onClose();
            };

            return React.createElement('div', { className: "fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center animate-in fade-in" },
                React.createElement('div', { className: "bg-white w-full max-w-md p-6 rounded-t-3xl sm:rounded-3xl h-[90vh] sm:h-auto overflow-y-auto" },
                    React.createElement('div', { className: "flex justify-between items-center mb-4" }, React.createElement('h2', { className: "text-xl font-bold" }, "Nuevo Movimiento"), React.createElement('button', { onClick: onClose, className: "p-2 bg-gray-100 rounded-full" }, React.createElement(X, { size: 20 }))),
                    React.createElement('div', { className: "mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-xl border border-purple-100" },
                        React.createElement('label', { className: "text-xs font-bold text-purple-600 uppercase mb-2 flex items-center gap-1" }, React.createElement(Sparkles, { size: 14 }), " Registro M치gico con IA"),
                        React.createElement('div', { className: "flex gap-2" },
                            React.createElement('input', { value: magicInput, onChange: (e) => setMagicInput(e.target.value), placeholder: "Ej: Pagu칠 500 bolos de condominio", className: "flex-1 p-2 text-sm rounded-lg border border-purple-200 focus:outline-none focus:border-purple-500", onKeyDown: (e) => e.key === 'Enter' && handleMagicFill() }),
                            React.createElement('button', { onClick: handleMagicFill, disabled: isThinking, className: "bg-purple-600 text-white p-2 rounded-lg disabled:opacity-50 flex items-center justify-center min-w-[40px]" }, isThinking ? React.createElement(RefreshCw, { className: "animate-spin", size: 18 }) : React.createElement(BrainCircuit, { size: 18 }))
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-2 gap-2 mb-6" }, Object.keys(SEGMENTS).map(key => React.createElement('button', { key: key, onClick: () => setSegment(key), className: `p-2 rounded-lg text-xs font-bold transition-all border ${segment === key ? `${SEGMENTS[key].bg} ${SEGMENTS[key].color} border-current` : 'bg-gray-50 text-gray-500 border-transparent'}` }, SEGMENTS[key].label))),
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement('div', { className: "flex gap-2" },
                            React.createElement('div', { className: "relative flex-1" },
                                React.createElement('span', { className: "absolute left-4 top-3.5 text-gray-400 font-bold" }, currency === 'USD' ? '$' : 'Bs'),
                                React.createElement('input', { type: "number", step: "0.01", placeholder: "0.00", value: amount, onChange: e => setAmount(e.target.value), className: "w-full pl-10 pr-4 py-3 bg-gray-50 rounded-xl text-xl font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500" })
                            ),
                            React.createElement('select', { value: currency, onChange: e => setCurrency(e.target.value), className: "bg-gray-100 font-bold rounded-xl px-4 py-3 focus:outline-none" }, React.createElement('option', { value: "VES" }, "Bs"), React.createElement('option', { value: "USD" }, "USD"))
                        ),
                        currency === 'VES' && React.createElement('div', { className: "bg-blue-50 p-3 rounded-xl border border-blue-100" },
                            React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                                React.createElement('button', { type: "button", onClick: () => setRateType('bcv'), className: `p-2 rounded-lg text-xs font-bold border ${rateType === 'bcv' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-200'}` }, "BCV", React.createElement('br'), rates.bcv),
                                React.createElement('button', { type: "button", onClick: () => setRateType('parallel'), className: `p-2 rounded-lg text-xs font-bold border ${rateType === 'parallel' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-200'}` }, "Paralelo", React.createElement('br'), rates.parallel),
                                React.createElement('button', { type: "button", onClick: () => setRateType('manual'), className: `p-2 rounded-lg text-xs font-bold border ${rateType === 'manual' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-600 border-gray-200'}` }, "Manual")
                            ),
                            rateType === 'manual' && React.createElement('input', { type: "number", value: customRate, onChange: e => setCustomRate(e.target.value), className: "w-full mt-2 p-2 rounded border border-blue-200 text-center font-bold text-blue-600", placeholder: "Tasa personalizada" })
                        ),
                        React.createElement('div', { className: "space-y-1" }, React.createElement('label', { className: "text-xs font-bold text-gray-500 ml-1" }, `Concepto (${SEGMENTS[segment].label})`), React.createElement('select', { value: category, onChange: e => setCategory(e.target.value), className: "w-full p-3 bg-gray-50 rounded-xl border border-gray-200" }, (pnlStructure[segment] || []).map(c => React.createElement('option', { key: c, value: c }, c)))),
                        React.createElement('div', { className: "space-y-1" }, React.createElement('label', { className: "text-xs font-bold text-gray-500 ml-1" }, "Nota (Opcional)"), React.createElement('input', { type: "text", value: description, onChange: e => setDescription(e.target.value), className: "w-full p-3 bg-gray-50 rounded-xl border border-gray-200", placeholder: "Ej. Panader칤a" })),
                        React.createElement('div', { className: "text-center pt-2" }, React.createElement('span', { className: "text-gray-400 text-sm" }, "Monto final: "), React.createElement('span', { className: "text-xl font-bold text-emerald-600" }, `$${calculatedUSD.toFixed(2)}`)),
                        React.createElement(Button, { type: "submit", className: "mt-2" }, "Guardar Movimiento")
                    )
                )
            );
        };

        const RatesCard = ({ rates, onUpdateRate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempRates, setTempRates] = useState(rates);
            useEffect(() => setTempRates(rates), [rates]);
            const handleSave = () => { onUpdateRate(tempRates); setIsEditing(false); };
            if (isEditing) { return React.createElement(Card, { className: "bg-indigo-50 border-indigo-100" }, React.createElement('div', { className: "flex justify-between items-center mb-3" }, React.createElement('h3', { className: "text-sm font-bold text-indigo-800 uppercase" }, "Editar Tasas"), React.createElement('button', { onClick: handleSave, className: "text-xs bg-indigo-600 text-white px-3 py-1 rounded-lg font-bold" }, "Guardar")), React.createElement('div', { className: "grid grid-cols-2 gap-4" }, React.createElement('div', null, React.createElement('label', { className: "text-[10px] text-indigo-400 font-bold block mb-1" }, "BCV"), React.createElement('input', { type: "number", value: tempRates.bcv, onChange: e => setTempRates({...tempRates, bcv: e.target.value}), className: "w-full p-2 rounded-lg text-center font-bold text-indigo-700" })), React.createElement('div', null, React.createElement('label', { className: "text-[10px] text-indigo-400 font-bold block mb-1" }, "PARALELO"), React.createElement('input', { type: "number", value: tempRates.parallel, onChange: e => setTempRates({...tempRates, parallel: e.target.value}), className: "w-full p-2 rounded-lg text-center font-bold text-indigo-700" })))); }
            return React.createElement(Card, { className: "bg-indigo-50 border-indigo-100" }, React.createElement('div', { className: "flex justify-between items-center mb-3" }, React.createElement('h3', { className: "text-xs font-bold text-indigo-400 uppercase tracking-widest" }, "Tasas del D칤a"), React.createElement('button', { onClick: () => setIsEditing(true), className: "p-1 hover:bg-indigo-100 rounded-full text-indigo-400" }, React.createElement(Settings, { size: 16 }))), React.createElement('div', { className: "flex justify-around items-center" }, React.createElement('div', { className: "text-center" }, React.createElement('p', { className: "text-2xl font-bold text-indigo-900" }, rates.bcv), React.createElement('p', { className: "text-[10px] font-bold text-indigo-400" }, "BCV")), React.createElement('div', { className: "h-8 w-px bg-indigo-200" }), React.createElement('div', { className: "text-center" }, React.createElement('p', { className: "text-2xl font-bold text-indigo-900" }, rates.parallel), React.createElement('p', { className: "text-[10px] font-bold text-indigo-400" }, "PARALELO"))));
        };

        const HomeView = ({ rates, transactions, onUpdateRate, onOpenAdd, onOpenConfig }) => {
            const balance = transactions.reduce((acc, curr) => { return curr.type === 'income' ? acc + (curr.amountUSD || 0) : acc - (curr.amountUSD || 0); }, 0);
            const recent = transactions.slice(0, 5);
            return React.createElement('div', { className: "p-5 pb-32 space-y-6" },
                React.createElement('header', { className: "flex justify-between items-center pt-2" }, React.createElement('div', null, React.createElement('h1', { className: "text-2xl font-bold text-gray-800" }, "Mi Billetera"), React.createElement('p', { className: "text-sm text-gray-500" }, "P&L Personal 游游")), React.createElement('button', { onClick: onOpenConfig, className: "w-10 h-10 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-200" }, React.createElement(List, { size: 20 }))),
                React.createElement('div', { className: "bg-emerald-600 text-white p-6 rounded-3xl shadow-lg shadow-emerald-200" }, React.createElement('p', { className: "text-emerald-100 text-xs font-bold uppercase tracking-widest mb-1" }, "Cash Flow Disponible"), React.createElement('h2', { className: "text-4xl font-bold mb-4" }, `$${balance.toFixed(2)}`), React.createElement('div', { className: "flex gap-3" }, React.createElement('button', { onClick: onOpenAdd, className: "flex-1 bg-white/20 hover:bg-white/30 py-2 rounded-xl text-sm font-bold flex items-center justify-center gap-2 backdrop-blur-sm transition-colors" }, React.createElement(Plus, { size: 16 }), "Registrar"))),
                React.createElement(RatesCard, { rates, onUpdateRate }),
                React.createElement('div', null, React.createElement('div', { className: "flex justify-between items-end mb-4" }, React.createElement('h3', { className: "font-bold text-gray-700" }, "Recientes"), React.createElement('span', { className: "text-xs text-emerald-600 font-medium" }, "Ver todo")), React.createElement('div', { className: "space-y-3" }, recent.map(t => React.createElement('div', { key: t.id, className: "bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm" }, React.createElement('div', { className: "flex items-center gap-3" }, React.createElement('div', { className: `w-10 h-10 rounded-full flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}` }, t.type === 'income' ? React.createElement(TrendingUp, { size: 18 }) : React.createElement(TrendingDown, { size: 18 })), React.createElement('div', null, React.createElement('p', { className: "font-bold text-sm text-gray-800" }, t.category), React.createElement('p', { className: "text-xs text-gray-400" }, t.segment ? SEGMENTS[t.segment]?.label : (t.type === 'income' ? 'Ingreso' : 'Gasto')))), React.createElement('div', { className: "text-right" }, React.createElement('p', { className: `font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}` }, t.type === 'income' ? '+' : '-', `$${(t.amountUSD || 0).toFixed(2)}`), React.createElement('p', { className: "text-xs text-gray-400" }, t.currency === 'USD' ? `$${t.amount}` : `Bs. ${t.amount}`))))))
            );
        };

        const HistoryView = ({ transactions }) => {
             return React.createElement('div', { className: "p-5 pb-32 space-y-4 pt-[env(safe-area-inset-top)]" }, React.createElement('h2', { className: "text-2xl font-bold text-gray-900 mb-4" }, "Historial P&L"), React.createElement('div', { className: "space-y-3" }, transactions.map(t => React.createElement('div', { key: t.id, className: "bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center" }, React.createElement('div', { className: "flex flex-col" }, React.createElement('span', { className: "font-bold text-gray-800" }, t.category), React.createElement('span', { className: "text-xs px-2 py-0.5 rounded-md w-fit mt-1 " + (t.segment ? SEGMENTS[t.segment].bg + " " + SEGMENTS[t.segment].color : "bg-gray-100 text-gray-500") }, t.segment ? SEGMENTS[t.segment].label : (t.type === 'income' ? 'Ingreso' : 'Gasto'))), React.createElement('div', { className: "text-right" }, React.createElement('span', { className: `block font-bold ${t.type === 'income' ? 'text-green-600' : 'text-gray-800'}` }, `$${(t.amountUSD || 0).toFixed(2)}`), React.createElement('span', { className: "text-xs text-gray-400" }, t.currency === 'USD' ? 'USD' : `Bs ${t.amount}`))))));
        };
        
        const PnLReportView = ({ transactions, pnlStructure }) => {
            const [granularity, setGranularity] = useState('monthly');
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setMonth(d.getMonth() - 5); return d.toISOString().split('T')[0]; });
            const [endDate, setEndDate] = useState(() => new Date().toISOString().split('T')[0]);
            const [analysis, setAnalysis] = useState("");
            const [analyzing, setAnalyzing] = useState(false);

            const periods = useMemo(() => {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const periodsArr = [];
                let current = new Date(start);
                end.setHours(23, 59, 59, 999);
                while (current <= end) {
                    let label = "", id = "";
                    if (granularity === 'daily') { id = current.toISOString().split('T')[0]; label = current.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }); current.setDate(current.getDate() + 1); } 
                    else if (granularity === 'weekly') { const lastDay = new Date(current); lastDay.setDate(lastDay.getDate() + 6); id = current.toISOString().split('T')[0]; label = `${current.getDate()}/${current.getMonth()+1}`; current.setDate(current.getDate() + 7); } 
                    else if (granularity === 'monthly') { id = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`; label = current.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }); current.setMonth(current.getMonth() + 1); } 
                    else if (granularity === 'yearly') { id = `${current.getFullYear()}`; label = `${current.getFullYear()}`; current.setFullYear(current.getFullYear() + 1); }
                    periodsArr.push({ id, label });
                }
                return periodsArr;
            }, [startDate, endDate, granularity]);

            const reportData = useMemo(() => {
                const data = { net: {} }; 
                const segments = ['ingresos', 'gastos_fijos', 'gastos_variables', 'ahorro'];
                segments.forEach(seg => {
                    data[seg] = { concepts: {}, total: {} };
                    (pnlStructure[seg] || []).forEach(concept => { data[seg].concepts[concept] = {}; periods.forEach(p => data[seg].concepts[concept][p.id] = 0); });
                    periods.forEach(p => data[seg].total[p.id] = 0);
                });
                periods.forEach(p => data.net[p.id] = 0);
                transactions.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate < new Date(startDate) || tDate > new Date(endDate + "T23:59:59")) return;
                    let pId = "";
                    if (granularity === 'daily') pId = t.date.split('T')[0];
                    else if (granularity === 'monthly') pId = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2, '0')}`;
                    else if (granularity === 'yearly') pId = `${tDate.getFullYear()}`;
                    else if (granularity === 'weekly') { const tTime = tDate.getTime(); const period = periods.find((p, i) => { const pStart = new Date(p.id).getTime(); const nextP = periods[i+1]; const pEnd = nextP ? new Date(nextP.id).getTime() : Infinity; return tTime >= pStart && tTime < pEnd; }); if(period) pId = period.id; }
                    if (pId && data[t.segment]) {
                        const amount = t.amountUSD || 0;
                        if (!data[t.segment].concepts[t.category]) { data[t.segment].concepts[t.category] = {}; periods.forEach(p => data[t.segment].concepts[t.category][p.id] = 0); }
                        if (data[t.segment].concepts[t.category][pId] !== undefined) data[t.segment].concepts[t.category][pId] += amount;
                        data[t.segment].total[pId] += amount;
                        if (SEGMENTS[t.segment].type === 'income') data.net[pId] += amount; else data.net[pId] -= amount;
                    }
                });
                return data;
            }, [transactions, periods, granularity, startDate, endDate, pnlStructure]);

            const handleAnalyze = async () => {
                setAnalyzing(true);
                setAnalysis("");
                const summary = { periodo: `${startDate} al ${endDate}`, totales_por_segmento: { ingresos: Object.values(reportData.ingresos.total).reduce((a,b)=>a+b, 0), gastos_fijos: Object.values(reportData.gastos_fijos.total).reduce((a,b)=>a+b, 0), gastos_variables: Object.values(reportData.gastos_variables.total).reduce((a,b)=>a+b, 0), ahorro: Object.values(reportData.ahorro.total).reduce((a,b)=>a+b, 0), }, flujo_neto: Object.values(reportData.net).reduce((a,b)=>a+b, 0) };
                const prompt = `Act칰a como asesor financiero experto. Analiza este resumen P&L (en USD): ${JSON.stringify(summary)}. Dame 3 puntos clave breves en espa침ol con emojis: 1. Salud financiera general. 2. Observaci칩n sobre gastos. 3. Recomendaci칩n de ahorro. S칠 directo y motivador.`;
                const result = await callGemini(prompt);
                setAnalysis(result || "No se pudo generar el an치lisis.");
                setAnalyzing(false);
            };

            return React.createElement('div', { className: "h-full flex flex-col pt-[env(safe-area-inset-top)]" },
                React.createElement('div', { className: "p-4 bg-white border-b border-gray-200" },
                    React.createElement('div', { className: "flex justify-between items-center mb-4" },
                        React.createElement('h2', { className: "text-2xl font-bold text-gray-900" }, "Reporte P&L"),
                         React.createElement('select', { value: granularity, onChange: e => setGranularity(e.target.value), className: "bg-gray-100 rounded-lg px-3 py-1 text-sm font-bold" }, React.createElement('option', { value: "daily" }, "Diario"), React.createElement('option', { value: "weekly" }, "Semanal"), React.createElement('option', { value: "monthly" }, "Mensual"), React.createElement('option', { value: "yearly" }, "Anual"))
                    ),
                    React.createElement('div', { className: "flex gap-2 text-sm mb-4" }, React.createElement('input', { type: "date", value: startDate, onChange: e => setStartDate(e.target.value), className: "w-full bg-gray-50 border border-gray-200 rounded-lg px-2 py-1 font-medium" }), React.createElement('input', { type: "date", value: endDate, onChange: e => setEndDate(e.target.value), className: "w-full bg-gray-50 border border-gray-200 rounded-lg px-2 py-1 font-medium" })),
                    React.createElement(Button, { onClick: handleAnalyze, variant: "magic", disabled: analyzing }, analyzing ? "Analizando..." : React.createElement(React.Fragment, null, React.createElement(Sparkles, { size: 18 }), " Analizar con IA")),
                    analysis && React.createElement('div', { className: "mt-3 p-3 bg-purple-50 border border-purple-100 rounded-xl text-sm text-purple-800 whitespace-pre-line leading-relaxed" }, analysis)
                ),
                React.createElement('div', { className: "flex-1 overflow-auto bg-white pnl-table-container pb-20" },
                    React.createElement('table', { className: "pnl-table" },
                        React.createElement('thead', null, React.createElement('tr', null, React.createElement('th', { className: "pnl-cell-head pnl-col-sticky" }, "Concepto"), periods.map(p => React.createElement('th', { key: p.id, className: "pnl-cell-head min-w-[80px]" }, p.label)))),
                        React.createElement('tbody', null,
                            ['ingresos', 'gastos_fijos', 'gastos_variables', 'ahorro'].map(seg => 
                                React.createElement(React.Fragment, { key: seg },
                                    React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-group-header" }, SEGMENTS[seg].label.toUpperCase()), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-group-header" }))),
                                    Object.entries(reportData[seg].concepts).map(([concept, values]) => React.createElement('tr', { key: concept }, React.createElement('td', { className: "pnl-cell pnl-col-sticky text-gray-600 pl-4" }, concept), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell" }, values[p.id] === 0 ? '-' : Math.round(values[p.id]).toLocaleString())))),
                                    React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-total text-gray-800" }, `Total ${SEGMENTS[seg].label}`), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-total" }, Math.round(reportData[seg].total[p.id]).toLocaleString())))
                                )
                            ),
                            React.createElement('tr', null, React.createElement('td', { colSpan: periods.length + 1, className: "h-4 bg-gray-50" })),
                            React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-net" }, "RESULTADO NETO"), periods.map(p => React.createElement('td', { key: p.id, className: `pnl-cell pnl-row-net ${reportData.net[p.id] < 0 ? 'text-red-600' : 'text-emerald-700'}` }, Math.round(reportData.net[p.id]).toLocaleString())))
                        )
                    )
                )
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [rates, setRates] = useState({ bcv: 36.5, parallel: 40.2 });
            const [transactions, setTransactions] = useState([]);
            const [pnlStructure, setPnlStructure] = useState(DEFAULT_PNL);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [currentTab, setCurrentTab] = useState('home');

            useEffect(() => {
                onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const ratesRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'rates');
                const unsubRates = onSnapshot(ratesRef, (doc) => { if (doc.exists()) setRates(doc.data()); else setDoc(ratesRef, { bcv: 36.5, parallel: 40.2 }); });
                const pnlRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'pnl');
                const unsubPnl = onSnapshot(pnlRef, (doc) => { if (doc.exists()) setPnlStructure(doc.data()); else setDoc(pnlRef, DEFAULT_PNL); });
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'));
                const unsubTrans = onSnapshot(q, (snapshot) => { let data = snapshot.docs.map(d => ({id: d.id, ...d.data()})); data.sort((a, b) => new Date(b.date) - new Date(a.date)); setTransactions(data); });

                return () => { unsubRates(); unsubTrans(); unsubPnl(); };
            }, [user]);

            const updateRates = async (newRates) => { if(!user) return; await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'rates'), { bcv: parseFloat(newRates.bcv), parallel: parseFloat(newRates.parallel) }); };
            const updatePnl = async (newPnl) => { if(!user) return; await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'pnl'), newPnl); };

            if (!user) return React.createElement(LoginScreen);

            return React.createElement('div', { className: "h-screen w-full bg-gray-50 flex flex-col" },
                React.createElement('div', { className: "flex-1 overflow-y-auto no-scrollbar" },
                    currentTab === 'home' ? React.createElement(HomeView, { rates, transactions, onUpdateRate: updateRates, onOpenAdd: () => setShowAddModal(true), onOpenConfig: () => setShowConfigModal(true) }) :
                    currentTab === 'history' ? React.createElement(HistoryView, { transactions }) :
                    currentTab === 'report' ? React.createElement(PnLReportView, { transactions, pnlStructure }) : null
                ),
                currentTab === 'home' && React.createElement('div', { className: "fixed bottom-24 left-1/2 transform -translate-x-1/2 z-40 safe-bottom" },
                    React.createElement('button', { onClick: () => setShowAddModal(true), className: "bg-emerald-600 text-white p-4 rounded-full shadow-xl shadow-emerald-200 hover:scale-105 transition-transform" }, React.createElement(Plus, { size: 28 }))
                ),
                React.createElement('nav', { className: "bg-white border-t border-gray-200 pb-safe pt-2 px-6 flex justify-between items-center z-30 safe-bottom" },
                    React.createElement('button', { onClick: () => setCurrentTab('home'), className: `flex flex-col items-center gap-1 p-2 ${currentTab === 'home' ? 'text-emerald-600' : 'text-gray-400'}` }, React.createElement(Home, { size: 24 }), React.createElement('span', { className: "text-[10px] font-bold" }, "Inicio")),
                    React.createElement('button', { onClick: () => setCurrentTab('history'), className: `flex flex-col items-center gap-1 p-2 ${currentTab === 'history' ? 'text-emerald-600' : 'text-gray-400'}` }, React.createElement(History, { size: 24 }), React.createElement('span', { className: "text-[10px] font-bold" }, "Historial")),
                     React.createElement('button', { onClick: () => setCurrentTab('report'), className: `flex flex-col items-center gap-1 p-2 ${currentTab === 'report' ? 'text-emerald-600' : 'text-gray-400'}` }, React.createElement(FileSpreadsheet, { size: 24 }), React.createElement('span', { className: "text-[10px] font-bold" }, "Reporte"))
                ),
                showAddModal && React.createElement(AddTransactionModal, { onClose: () => setShowAddModal(false), rates, userId: user.uid, pnlStructure }),
                showConfigModal && React.createElement(PnLConfigModal, { onClose: () => setShowConfigModal(false), pnlData: pnlStructure, onUpdatePnl: updatePnl })
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
