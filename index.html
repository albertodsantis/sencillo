<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sencillo v3.5</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            base: '#050505',    // Negro casi puro
                            surface: '#121212', // Gris muy oscuro para tarjetas
                            highlight: '#1E1E1E', // Para inputs/hovers
                        },
                        brand: {
                            light: '#6EE7B7', // Emerald 300
                            DEFAULT: '#10B981', // Emerald 500
                            dark: '#047857',   // Emerald 700
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'], // Tipografía moderna geométrica
                    },
                    backgroundImage: {
                        'card-gradient': 'linear-gradient(135deg, #34D399 0%, #059669 100%)', // Degradado verde rico
                        'app-bg': 'radial-gradient(circle at 50% 0%, #1e293b 0%, #050505 40%)', // Brillo sutil arriba
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    
    <!-- Fuente Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            font-family: 'Outfit', sans-serif; 
            background-color: #050505;
            color: #ffffff;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Estilos P&L Oscuro Mejorado */
        .pnl-table-container { overflow-x: auto; position: relative; }
        .pnl-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.85rem; }
        .pnl-cell { padding: 14px 16px; white-space: nowrap; border-bottom: 1px solid #1E1E1E; color: #A1A1AA; text-align: right; }
        .pnl-cell-head { font-weight: 600; background-color: #050505; color: #6EE7B7; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.7rem; position: sticky; top: 0; z-index: 10; text-align: center; border-bottom: 1px solid #333; }
        .pnl-col-sticky { position: sticky; left: 0; background-color: #050505; z-index: 20; border-right: 1px solid #1E1E1E; text-align: left; min-width: 140px; }
        .pnl-col-sticky.pnl-cell-head { z-index: 30; } 
        .pnl-row-group-header { background-color: #121212; font-weight: 700; color: #FFFFFF; }
        .pnl-row-total { background-color: #0f172a; font-weight: 700; color: #34D399; }
        .pnl-row-net { background-color: #121212; font-weight: 800; color: #10B981; border-top: 1px solid #333; }
        .pnl-row-available { background-color: #121212; font-weight: 800; color: #3B82F6; border-top: 1px solid #333; }

        /* Efecto Glass */
        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Ajuste inputs date en dark mode */
        ::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body class="bg-app-bg text-white overflow-hidden h-full">
    <div id="root" class="h-full"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, Component, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wallet, TrendingUp, TrendingDown, Plus, Settings, 
            Calendar, DollarSign, RefreshCw, X, Save, ArrowRightLeft,
            LogOut, ChevronDown, Filter, Home, History, PieChart, Trash2, List, FileSpreadsheet,
            Users, User, Check, Repeat, Pencil, Loader2, ArrowUpRight, ArrowDownLeft, ChevronLeft, ChevronRight, PiggyBank, Mail, Lock, Search, AlertCircle, ShieldCheck, Bug, Database, Terminal
        } from 'lucide-react';

        // --- FIREBASE (Versión 10.8.0 - GOLDEN STABLE) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            GoogleAuthProvider, 
            signOut,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            initializeFirestore, 
            memoryLocalCache, 
            collection, 
            doc, 
            setDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            limit, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            where
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURACIÓN GLOBAL ---
        const ROOT_COLLECTION = 'projects';
        const PROJECT_DOC_ID = 'sencillo-app-40a36';
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCAd_vju_x9wuhGtZJvvoWpt9JbRUwB63k",
            authDomain: "sencillo-app-40a36.firebaseapp.com",
            databaseURL: "https://sencillo-app-40a36-default-rtdb.firebaseio.com",
            projectId: "sencillo-app-40a36",
            storageBucket: "sencillo-app-40a36.firebasestorage.app",
            messagingSenderId: "27193285455",
            appId: "1:27193285455:web:6cb0f8ac14f0e36fb0433a"
        };

        // --- SISTEMA DE LOGS INTERNO ---
        const logs = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        function addLog(type, ...args) {
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
            logs.push({ type, msg, time: new Date().toLocaleTimeString() });
            if (logs.length > 50) logs.shift();
            if (type === 'error') originalConsoleError(...args);
            else originalConsoleLog(...args);
        }

        console.log = (...args) => addLog('info', ...args);
        console.error = (...args) => addLog('error', ...args);

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) {
                this.setState({ error, errorInfo });
                console.error("Uncaught Error:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return React.createElement('div', { className: "h-screen flex flex-col items-center justify-center p-6 bg-dark-base text-white text-center" },
                        React.createElement(Bug, { size: 48, className: "text-red-500 mb-4" }),
                        React.createElement('h2', { className: "text-2xl font-bold mb-2" }, "¡Ups! Algo salió mal"),
                        React.createElement('p', { className: "text-gray-400 mb-4" }, "La aplicación ha encontrado un error inesperado."),
                        React.createElement('button', { onClick: () => window.location.reload(), className: "bg-white text-black px-6 py-3 rounded-xl font-bold" }, "Recargar Aplicación")
                    );
                }
                return this.props.children;
            }
        }

        // Inicializar Firebase
        let app, auth, db;
        try {
            app = initializeApp(FIREBASE_CONFIG);
            auth = getAuth(app);
            
            try {
                db = initializeFirestore(app, { 
                    localCache: memoryLocalCache()
                }, PROJECT_DOC_ID);
                console.log(`Modo DB: Conectado a base de datos "${PROJECT_DOC_ID}"`);
            } catch (e) {
                console.error("Error conectando a DB nombrada, fallback:", e);
                db = getFirestore(app); 
            }
            
            console.log(`Firebase OK. Path: ${ROOT_COLLECTION}/${PROJECT_DOC_ID}`);
        } catch (error) {
            console.error("CRITICAL: Error inicializando Firebase:", error);
        }

        // --- DEBUGGER FLOTANTE ---
        const DebugPanel = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [logList, setLogList] = useState(logs);

            useEffect(() => {
                if(!isOpen) return;
                const interval = setInterval(() => setLogList([...logs]), 1000);
                return () => clearInterval(interval);
            }, [isOpen]);

            if (!isOpen) {
                return React.createElement('button', { 
                    onClick: () => setIsOpen(true),
                    className: "fixed bottom-24 left-4 z-50 bg-gray-800 text-white p-3 rounded-full shadow-lg opacity-50 hover:opacity-100"
                }, React.createElement(Bug, { size: 20 }));
            }

            return React.createElement('div', { className: "fixed inset-0 z-50 bg-black/90 p-4 flex flex-col font-mono text-xs overflow-hidden" },
                React.createElement('div', { className: "flex justify-between items-center mb-2 border-b border-gray-700 pb-2" },
                    React.createElement('h3', { className: "text-brand font-bold" }, "DEBUG CONSOLE"),
                    React.createElement('button', { onClick: () => setIsOpen(false), className: "text-white p-2" }, React.createElement(X, { size: 20 }))
                ),
                React.createElement('div', { className: "flex-1 overflow-auto space-y-1" },
                    logList.map((l, i) => 
                        React.createElement('div', { key: i, className: `${l.type === 'error' ? 'text-red-400' : 'text-green-400'}` }, `[${l.time}] ${l.msg}`)
                    )
                ),
                React.createElement('div', { className: "pt-2 text-gray-500 text-[10px]" }, 
                    `DB ID: ${PROJECT_DOC_ID} | Path: ${ROOT_COLLECTION}`
                )
            );
        };

        // --- CONSTANTES ---
        const DEFAULT_PNL = {
            ingresos: ["Sueldo", "Honorarios", "Ventas"],
            gastos_fijos: ["Alquiler", "Internet", "Condominio", "Colegio", "Suscripciones"],
            gastos_variables: ["Mercado", "Salidas", "Salud", "Transporte", "Gustos"],
            ahorro: ["Ahorro General"]
        };

        const SEGMENTS = {
            ingresos: { label: "Ingresos", color: "text-emerald-400", bg: "bg-emerald-400/10", type: "income" },
            ahorro: { label: "Ahorro", color: "text-blue-400", bg: "bg-blue-400/10", type: "expense" },
            gastos_fijos: { label: "Gastos Fijos", color: "text-orange-400", bg: "bg-orange-400/10", type: "expense" },
            gastos_variables: { label: "Gastos Variables", color: "text-rose-400", bg: "bg-rose-400/10", type: "expense" }
        };

        const RECURRENCE_OPTIONS = {
            none: "No repetir",
            weekly: "Semanalmente",
            monthly: "Mensualmente",
            yearly: "Anualmente"
        };

        // --- API HELPERS ---
        const getRatesFromAPI = async () => {
            try {
                const [bcvRes, parallelRes] = await Promise.all([
                    fetch('https://ve.dolarapi.com/v1/dolares/oficial').catch(() => null),
                    fetch('https://ve.dolarapi.com/v1/dolares/paralelo').catch(() => null)
                ]);
                
                const newRates = {};
                if (bcvRes && bcvRes.ok) {
                    const bcvData = await bcvRes.json();
                    if (bcvData.promedio) newRates.bcv = parseFloat(bcvData.promedio);
                }
                if (parallelRes && parallelRes.ok) {
                    const parallelData = await parallelRes.json();
                    if (parallelData.promedio) newRates.parallel = parseFloat(parallelData.promedio);
                }
                return newRates;
            } catch (e) {
                console.error("Error fetching rates:", e);
                return null;
            }
        };
        
        const getLocalDateString = (dateObj = new Date()) => {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- COMPONENTES UI ---

        const Card = ({ children, className = "" }) => (
            React.createElement('div', { className: `bg-dark-surface p-6 rounded-3xl border border-white/5 ${className}` }, children)
        );

        const Button = ({ children, onClick, variant = 'primary', className = '', type="button", disabled = false }) => {
            const variants = {
                primary: "bg-card-gradient text-white shadow-lg shadow-emerald-500/20 font-bold border border-white/10", 
                secondary: "bg-dark-highlight text-white border border-white/10 hover:bg-white/10",
                danger: "bg-red-500/10 text-red-500 hover:bg-red-500/20 border border-red-500/20",
                ghost: "text-gray-400 hover:text-white hover:bg-white/5",
                indigo: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-md shadow-indigo-500/30",
            };
            return React.createElement('button', { 
                onClick, type, disabled,
                className: `px-6 py-4 rounded-2xl font-semibold text-sm tracking-wide transition-all active:scale-[0.98] flex items-center justify-center gap-2 w-full ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`
            }, children);
        };

        // --- PANTALLAS ---

        const LoginScreen = () => {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setErrorMsg(null);

                if (!email || !password) {
                    setErrorMsg("Por favor completa todos los campos");
                    setLoading(false);
                    return;
                }

                try {
                    if (!auth) throw new Error("Firebase no inicializado.");
                    
                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                    setLoading(false);
                    
                    if (error.code === 'auth/invalid-email') setErrorMsg("El email no es válido.");
                    else if (error.code === 'auth/user-disabled') setErrorMsg("Usuario deshabilitado.");
                    else if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') setErrorMsg("Usuario no encontrado o contraseña incorrecta.");
                    else if (error.code === 'auth/wrong-password') setErrorMsg("Contraseña incorrecta.");
                    else if (error.code === 'auth/email-already-in-use') setErrorMsg("El email ya está registrado.");
                    else if (error.code === 'auth/weak-password') setErrorMsg("La contraseña es muy débil (mínimo 6 caracteres).");
                    else setErrorMsg("Error: " + error.message);
                }
            };

            const handleGoogleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Auth Error:", error);
                    setErrorMsg("Google Auth falló (común en vistas previas).");
                }
            };
            
            return React.createElement('div', { 
                className: "h-full flex flex-col items-center justify-center p-6 bg-app-bg text-white",
                style: { paddingTop: "calc(env(safe-area-inset-top) + 40px)", paddingBottom: "40px" } 
            },
                React.createElement('div', { className: "w-full max-w-sm" },
                    React.createElement('div', { className: "text-center mb-8" },
                        React.createElement('div', { className: "w-24 h-24 bg-card-gradient rounded-3xl rotate-3 flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-emerald-500/20 text-white" },
                            React.createElement(Wallet, { size: 48 })
                        ),
                        React.createElement('h1', { className: "text-4xl font-black mb-2 tracking-tight" }, "Sencillo"),
                        React.createElement('p', { className: "text-gray-400 text-lg font-light" }, "Tus cuentas claras")
                    ),
                    
                    errorMsg && React.createElement('div', { className: "mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-400 text-sm flex items-center gap-2" }, 
                        React.createElement(AlertCircle, { size: 16 }),
                        errorMsg
                    ),
                    
                    loading ? React.createElement('p', { className: "text-center text-gray-500 text-sm mb-4 animate-pulse" }, "Conectando...") : null,

                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement('div', { className: "space-y-1" },
                             React.createElement('label', { className: "text-xs font-bold text-gray-500 ml-1 uppercase" }, "Email"),
                             React.createElement('div', { className: "relative" },
                                React.createElement('span', { className: "absolute left-4 top-3.5 text-gray-500" }, React.createElement(Mail, { size: 18 })),
                                React.createElement('input', { 
                                    type: "email", 
                                    value: email, 
                                    onChange: (e) => setEmail(e.target.value),
                                    className: "w-full pl-11 pr-4 py-3 bg-dark-surface border border-white/10 rounded-xl text-white focus:outline-none focus:border-brand placeholder-gray-700 transition-colors",
                                    placeholder: "hola@ejemplo.com"
                                })
                             )
                        ),
                        React.createElement('div', { className: "space-y-1" },
                             React.createElement('label', { className: "text-xs font-bold text-gray-500 ml-1 uppercase" }, "Contraseña"),
                             React.createElement('div', { className: "relative" },
                                React.createElement('span', { className: "absolute left-4 top-3.5 text-gray-500" }, React.createElement(Lock, { size: 18 })),
                                React.createElement('input', { 
                                    type: "password", 
                                    value: password, 
                                    onChange: (e) => setPassword(e.target.value),
                                    className: "w-full pl-11 pr-4 py-3 bg-dark-surface border border-white/10 rounded-xl text-white focus:outline-none focus:border-brand placeholder-gray-700 transition-colors",
                                    placeholder: "••••••••"
                                })
                             )
                        ),
                        
                        React.createElement(Button, { type: "submit", disabled: loading, className: "mt-6" }, 
                            loading ? React.createElement(Loader2, { className: "animate-spin" }) : (isSignUp ? "Registrarse" : "Entrar")
                        ),

                        React.createElement('div', { className: "relative flex py-2 items-center mt-4" },
                            React.createElement('div', { className: "flex-grow border-t border-white/10" }),
                            React.createElement('span', { className: "flex-shrink mx-4 text-gray-500 text-xs" }, "O continúa con"),
                            React.createElement('div', { className: "flex-grow border-t border-white/10" })
                        ),

                        React.createElement('button', { 
                            type: "button",
                            onClick: handleGoogleLogin,
                            className: "w-full py-3 bg-white text-black font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-gray-200 transition-colors mt-4"
                        }, 
                             React.createElement('svg', { className: "w-5 h-5", viewBox: "0 0 24 24" }, 
                                React.createElement('path', { d: "M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z", fill: "#4285F4" }),
                                React.createElement('path', { d: "M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z", fill: "#34A853" }),
                                React.createElement('path', { d: "M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26.81-.58z", fill: "#FBBC05" }),
                                React.createElement('path', { d: "M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z", fill: "#EA4335" })
                             ),
                             "Google"
                        ),

                        React.createElement('div', { className: "mt-8 text-center" },
                            React.createElement('button', { 
                                type: "button",
                                onClick: () => { setIsSignUp(!isSignUp); setErrorMsg(null); },
                                className: "text-sm text-gray-400 hover:text-brand transition-colors"
                            }, isSignUp ? "¿Ya tienes cuenta? Inicia sesión" : "¿No tienes cuenta? Regístrate")
                        )
                    )
                )
            );
        };

        const ConfigView = ({ pnlData, onUpdatePnl, userId }) => {
            const [localPnl, setLocalPnl] = useState(pnlData);
            const [newConcept, setNewConcept] = useState("");
            const [activeSegment, setActiveSegment] = useState("ingresos"); 
            const [isSaved, setIsSaved] = useState(false);
            const [testStatus, setTestStatus] = useState(null);

            useEffect(() => setLocalPnl(pnlData), [pnlData]);

            const handleAdd = () => {
                if (!newConcept.trim()) return;
                const updatedList = [...(localPnl[activeSegment] || []), newConcept.trim()];
                setLocalPnl({ ...localPnl, [activeSegment]: updatedList });
                setNewConcept("");
            };

            const handleDelete = (segment, index) => {
                const updatedList = localPnl[segment].filter((_, i) => i !== index);
                setLocalPnl({ ...localPnl, [segment]: updatedList });
            };

            const handleSave = () => {
                onUpdatePnl(localPnl);
                setIsSaved(true);
                setTimeout(() => setIsSaved(false), 2000);
            };
            
            const runConnectionTest = async () => {
                setTestStatus("Probando...");
                console.log("Iniciando prueba de escritura...");
                
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("La red tarda demasiado (Timeout)")), 15000));
                
                try {
                    const testRef = doc(db, ROOT_COLLECTION, PROJECT_DOC_ID, 'users', userId, 'system', 'connection_test');
                    
                    const writeOp = setDoc(testRef, { 
                        last_check: new Date().toISOString(),
                        status: "ok",
                        platform: navigator.userAgent
                    });
                    
                    await Promise.race([writeOp, timeout]);
                    
                    const msg = `✅ ÉXITO (${ROOT_COLLECTION}/${PROJECT_DOC_ID})`;
                    console.log(msg);
                    setTestStatus(msg);
                    alert("¡CONEXIÓN EXITOSA!\n\nLa base de datos respondió correctamente.\nRevisa tu consola de Firebase ahora.");
                } catch (e) {
                    console.error("Test Error:", e);
                    setTestStatus("❌ ERROR: " + (e.code || e.message));
                    alert(`ERROR DE CONEXIÓN:\n\n${e.code || 'UNKNOWN'}\n\n${e.message}\n\nIntenta recargar la página o usar otra red Wi-Fi.`);
                }
            };

            return React.createElement('div', { className: "h-full flex flex-col pt-[env(safe-area-inset-top)] bg-app-bg" },
                React.createElement('div', { className: "p-6" },
                    React.createElement('div', { className: "flex justify-between items-center mb-1" },
                        React.createElement('h2', { className: "text-3xl font-bold text-white tracking-tight" }, "Configuración"),
                        React.createElement('span', { className: "text-xs font-bold text-brand bg-brand/10 px-2 py-1 rounded-md" }, "v3.4")
                    ),
                    React.createElement('p', { className: "text-gray-400 font-light" }, "Personaliza tus categorías")
                ),

                React.createElement('div', { className: "flex-1 overflow-y-auto px-6 pb-32" },
                    React.createElement('div', { className: "flex gap-3 overflow-x-auto pb-4 mb-2 scrollbar-hide" },
                        ["ingresos", "ahorro", "gastos_fijos", "gastos_variables"].map(seg => 
                            React.createElement('button', {
                                key: seg,
                                onClick: () => setActiveSegment(seg),
                                className: `px-5 py-3 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeSegment === seg ? 'bg-brand text-black' : 'bg-dark-surface text-gray-400 border border-white/10'}`
                            }, SEGMENTS[seg].label)
                        )
                    ),
                    
                    React.createElement('div', { className: "bg-dark-surface p-5 rounded-3xl border border-white/10 mb-6" },
                        React.createElement('p', { className: "text-xs text-gray-400 font-bold uppercase mb-3 tracking-wider" }, `Agregar a ${SEGMENTS[activeSegment].label}`),
                        React.createElement('div', { className: "flex gap-2" },
                            React.createElement('input', { 
                                value: newConcept, 
                                onChange: (e) => setNewConcept(e.target.value),
                                placeholder: "Nuevo concepto...",
                                className: "flex-1 p-4 rounded-2xl bg-dark-base border border-white/10 text-white focus:outline-none focus:border-brand transition-colors"
                            }),
                            React.createElement('button', { onClick: handleAdd, className: "bg-white text-black p-4 rounded-2xl hover:bg-gray-200 transition-colors" }, React.createElement(Plus, { size: 20 }))
                        )
                    ),

                    React.createElement('div', { className: "space-y-3" },
                        (localPnl[activeSegment] || []).map((concept, idx) => 
                            React.createElement('div', { key: idx, className: "flex justify-between items-center p-4 bg-dark-card rounded-2xl border border-gray-800" },
                                React.createElement('span', { className: "font-medium text-gray-200" }, concept),
                                React.createElement('button', { onClick: () => handleDelete(activeSegment, idx), className: "text-red-500 p-2 hover:bg-red-500/10 rounded-lg transition-colors" }, React.createElement(Trash2, { size: 18 }))
                            )
                        )
                    ),

                    React.createElement('div', { className: "mt-10 mb-10" },
                         React.createElement(Button, { onClick: handleSave }, isSaved ? "¡Guardado!" : "Guardar Cambios")
                    ),
                    
                    React.createElement('div', { className: "bg-gray-900/50 p-4 rounded-2xl border border-white/5 text-xs text-gray-500 space-y-3" },
                        React.createElement('div', { className: "flex items-center gap-2 mb-2" },
                            React.createElement(Database, { size: 14, className: "text-brand" }),
                            React.createElement('p', { className: "font-bold uppercase text-gray-300" }, "Diagnóstico de Conexión")
                        ),
                        React.createElement('div', { className: "flex justify-between" }, React.createElement('span', null, "User ID:"), React.createElement('span', { className: "font-mono" }, userId ? userId.slice(0,8) + "..." : "No auth")),
                        React.createElement('div', { className: "flex justify-between" }, React.createElement('span', null, "Project:"), React.createElement('span', { className: "font-mono" }, FIREBASE_CONFIG.projectId)),
                        React.createElement('div', { className: "flex justify-between" }, React.createElement('span', null, "Path:"), React.createElement('span', { className: "font-mono text-brand" }, `${ROOT_COLLECTION}/${PROJECT_DOC_ID}`)),
                        
                        React.createElement('div', { className: "pt-2 border-t border-white/5" },
                            React.createElement('button', { 
                                onClick: runConnectionTest,
                                className: "w-full py-3 bg-brand/20 text-brand border border-brand/30 rounded-xl font-bold hover:bg-brand/30 transition-colors flex items-center justify-center gap-2"
                            }, React.createElement(ShieldCheck, { size: 16 }), "PROBAR ESCRITURA EN DB")
                        ),
                        testStatus && React.createElement('p', { className: `text-center font-bold ${testStatus.includes('ERROR') ? 'text-red-400' : 'text-emerald-400'}` }, testStatus)
                    )
                )
            );
        };

        const BudgetView = ({ pnlStructure, budgets, onUpdateBudgets, transactions }) => {
            const [localBudgets, setLocalBudgets] = useState(budgets || {});
            const [isSaved, setIsSaved] = useState(false);

            useEffect(() => {
                setLocalBudgets(budgets || {});
            }, [budgets]);

            // Calculate current spending per category for current month
            const financials = useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const spending = {};
                let income = 0;
                let savings = 0;
                let fixed = 0;
                let variableTotal = 0;

                transactions.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
                        const amount = t.amountUSD || 0;
                        if (t.segment === 'gastos_variables') {
                            if (!spending[t.category]) spending[t.category] = 0;
                            spending[t.category] += amount;
                            variableTotal += amount;
                        } else if (t.segment === 'ingresos') {
                            income += amount;
                        } else if (t.segment === 'ahorro') {
                            savings += amount;
                        } else if (t.segment === 'gastos_fijos') {
                            fixed += amount;
                        }
                    }
                });
                return { spending, income, savings, fixed, variableTotal };
            }, [transactions]);

            const handleBudgetChange = (category, value) => {
                setLocalBudgets(prev => ({
                    ...prev,
                    [category]: parseFloat(value) || 0
                }));
            };

            const handleSave = () => {
                onUpdateBudgets(localBudgets);
                setIsSaved(true);
                setTimeout(() => setIsSaved(false), 2000);
            };

            const totalBudget = Object.values(localBudgets).reduce((a, b) => a + b, 0);
            const totalSpent = Object.values(financials.spending).reduce((a, b) => a + b, 0); 
            const remaining = totalBudget - totalSpent;
            const progress = totalBudget > 0 ? (financials.variableTotal / totalBudget) * 100 : 0;
            
            const realAvailable = (financials.income - financials.savings) - financials.fixed;

            return React.createElement('div', { className: "h-full flex flex-col pt-[env(safe-area-inset-top)] bg-app-bg" },
                React.createElement('div', { className: "p-6 bg-app-bg border-b border-white/5" },
                    React.createElement('h2', { className: "text-3xl font-bold text-white mb-1 tracking-tight" }, "Presupuesto"),
                    React.createElement('p', { className: "text-gray-400 font-medium mt-1" }, "Control de Gastos Variables")
                ),
                
                // Summary Card
                React.createElement('div', { className: "px-6 pb-2 mt-4" },
                     React.createElement('div', { className: "bg-dark-surface p-6 rounded-[2rem] border border-white/10 relative overflow-hidden" },
                        React.createElement('div', { className: "absolute top-0 right-0 w-32 h-32 bg-brand/5 rounded-full blur-3xl" }),
                        
                        React.createElement('div', { className: "flex justify-between items-end mb-4 relative z-10" },
                            React.createElement('div', null,
                                React.createElement('p', { className: "text-xs text-gray-500 font-bold uppercase tracking-wider mb-1" }, "Disponible Real (Ing - Aho - Fij)"),
                                React.createElement('p', { className: `text-3xl font-black ${realAvailable >= 0 ? 'text-brand' : 'text-red-500'}` }, `$${realAvailable.toFixed(2)}`)
                            ),
                            React.createElement('div', { className: "text-right" },
                                React.createElement('p', { className: "text-xs text-gray-500 font-bold uppercase tracking-wider mb-1" }, "Meta Gastos"),
                                React.createElement('p', { className: "text-lg font-bold text-white" }, `$${totalBudget.toFixed(0)}`)
                            )
                        ),
                        React.createElement('div', { className: "w-full bg-gray-800 rounded-full h-3 overflow-hidden" },
                            React.createElement('div', { className: `h-full rounded-full transition-all duration-500 ${progress > 100 ? 'bg-red-500' : 'bg-brand'}`, style: { width: `${Math.min(progress, 100)}%` } })
                        )
                    )
                ),

                React.createElement('div', { className: "flex-1 overflow-y-auto px-6 pb-36 mt-4 space-y-3" },
                    (pnlStructure['gastos_variables'] || []).map((category, idx) => {
                        const budget = localBudgets[category] || 0;
                        const spent = financials.spending[category] || 0; 
                        const percent = budget > 0 ? (spent / budget) * 100 : 0;
                        
                        let barColor = 'bg-brand';
                        let statusColor = 'text-gray-500';
                        if (percent > 80) { barColor = 'bg-yellow-500'; statusColor = 'text-yellow-500'; }
                        if (percent > 100) { barColor = 'bg-red-500'; statusColor = 'text-red-500'; }

                        return React.createElement('div', { key: idx, className: "bg-dark-surface p-4 rounded-2xl border border-white/5" },
                            React.createElement('div', { className: "flex justify-between items-center mb-3" },
                                React.createElement('div', null,
                                    React.createElement('span', { className: "font-bold text-white block" }, category),
                                    React.createElement('span', { className: `text-xs ${statusColor}` }, `$${spent.toFixed(0)} gastados`)
                                ),
                                React.createElement('div', { className: "flex items-center gap-2 bg-dark-base rounded-xl px-3 py-2 border border-white/5" },
                                    React.createElement('span', { className: "text-xs text-gray-500 font-bold" }, "$"),
                                    React.createElement('input', {
                                        type: "number",
                                        value: localBudgets[category] || '',
                                        onChange: (e) => handleBudgetChange(category, e.target.value),
                                        placeholder: "0",
                                        className: "w-16 bg-transparent text-right text-sm font-bold text-white focus:outline-none placeholder-gray-700"
                                    })
                                )
                            ),
                            React.createElement('div', { className: "w-full bg-gray-800/50 rounded-full h-1.5 overflow-hidden" },
                                React.createElement('div', { className: `h-full rounded-full transition-all duration-500 ${barColor}`, style: { width: `${Math.min(percent, 100)}%` } })
                            )
                        );
                    }),
                    
                    React.createElement('div', { className: "mt-8" },
                         React.createElement(Button, { onClick: handleSave }, isSaved ? "¡Guardado!" : "Guardar Presupuesto")
                    )
                )
            );
        };

        const RatesModal = ({ onClose, rates, onUpdateRate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [tempRates, setTempRates] = useState(rates);

            useEffect(() => setTempRates(rates), [rates]);
            
            const handleSave = () => { onUpdateRate(tempRates); onClose(); };
            const today = new Date().toLocaleDateString('es-VE', { day: 'numeric', month: 'numeric' });
            const gap = useMemo(() => { if (!tempRates.bcv || !tempRates.parallel) return 0; return ((tempRates.parallel - tempRates.bcv) / tempRates.bcv) * 100; }, [tempRates]);

            const fetchLiveRates = async () => {
                setIsRefreshing(true);
                const newRates = await getRatesFromAPI();
                if (newRates && newRates.bcv && newRates.parallel) setTempRates(newRates);
                else alert("Error al actualizar tasas.");
                setIsRefreshing(false);
            };

            return React.createElement('div', { className: "fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-center justify-center animate-fade-in" },
                React.createElement('div', { className: "bg-dark-base w-full max-w-sm p-6 rounded-[2rem] border border-white/10 shadow-2xl mx-4 animate-slide-up" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" }, 
                        React.createElement('div', { className: "flex items-baseline gap-2" },
                            React.createElement('h3', { className: "text-xl font-bold text-white tracking-tight" }, "Tasas del Día"),
                            React.createElement('span', { className: "text-sm text-gray-400" }, today)
                        ),
                        React.createElement('button', { onClick: onClose, className: "p-2 bg-dark-highlight rounded-full text-gray-400 hover:text-white transition-colors" }, React.createElement(X, { size: 20 }))
                    ),

                    React.createElement('div', { className: "space-y-4 mb-6" },
                         React.createElement('div', { className: "p-4 bg-dark-surface rounded-2xl border border-gray-800" },
                           React.createElement('label', { className: "text-xs text-gray-500 font-bold block mb-2" }, "BCV"),
                           React.createElement('input', { type: "number", value: tempRates.bcv, onChange: e => setTempRates({...tempRates, bcv: e.target.value}), className: "w-full bg-transparent text-3xl font-black text-white focus:outline-none placeholder-gray-700" })
                         ),
                         React.createElement('div', { className: "p-4 bg-dark-surface rounded-2xl border border-gray-800" },
                           React.createElement('label', { className: "text-xs text-gray-500 font-bold block mb-2" }, "PARALELO"),
                           React.createElement('input', { type: "number", value: tempRates.parallel, onChange: e => setTempRates({...tempRates, parallel: e.target.value}), className: "w-full bg-transparent text-3xl font-black text-white focus:outline-none placeholder-gray-700" })
                         )
                    ),
                    
                    React.createElement('div', { className: "flex justify-between items-center mb-6 px-2" },
                         React.createElement('span', { className: "text-sm text-gray-400 font-medium" }, "Brecha"),
                         React.createElement('span', { className: `text-sm font-bold ${gap > 10 ? 'text-red-500' : 'text-emerald-400'}` }, `${gap.toFixed(2)}%`)
                    ),

                    React.createElement('div', { className: "flex gap-3" },
                        React.createElement('button', { onClick: fetchLiveRates, className: "p-4 rounded-2xl bg-dark-surface border border-gray-700 text-white hover:bg-gray-800 transition-colors flex items-center justify-center" }, 
                            isRefreshing ? React.createElement(Loader2, { size: 20, className: "animate-spin" }) : React.createElement(RefreshCw, { size: 20 })
                        ),
                        React.createElement(Button, { onClick: handleSave, className: "flex-1" }, "Guardar Tasas")
                    )
                )
            );
        };

        const PnLReportView = ({ transactions, pnlStructure, recurringRules }) => {
            const [granularity, setGranularity] = useState('monthly');
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setDate(1); return getLocalDateString(d); });
            const [endDate, setEndDate] = useState(() => { const d = new Date(); d.setMonth(d.getMonth() + 1); return getLocalDateString(d); });

            const periods = useMemo(() => { const start = new Date(startDate + "T12:00:00"); const end = new Date(endDate + "T12:00:00"); const periodsArr = []; let current = new Date(start); let loopCount = 0; while (current <= end && loopCount < 1000) { let label = "", id = ""; if (granularity === 'daily') { id = current.toISOString().split('T')[0]; label = current.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }); current.setDate(current.getDate() + 1); } else if (granularity === 'weekly') { const lastDay = new Date(current); lastDay.setDate(lastDay.getDate() + 6); id = current.toISOString().split('T')[0]; label = `${current.getDate()}/${current.getMonth()+1}`; current.setDate(current.getDate() + 7); } else if (granularity === 'monthly') { id = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`; label = current.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }); current.setDate(1); current.setMonth(current.getMonth() + 1); } else if (granularity === 'yearly') { id = `${current.getFullYear()}`; label = `${current.getFullYear()}`; current.setFullYear(current.getFullYear() + 1); } periodsArr.push({ id, label }); loopCount++; } return periodsArr; }, [startDate, endDate, granularity]);
            const reportData = useMemo(() => { const data = { net: {}, available: {} }; const segments = ['ingresos', 'gastos_fijos', 'gastos_variables', 'ahorro']; segments.forEach(seg => { data[seg] = { concepts: {}, total: {} }; (pnlStructure[seg] || []).forEach(concept => { data[seg].concepts[concept] = {}; periods.forEach(p => data[seg].concepts[concept][p.id] = 0); }); periods.forEach(p => data[seg].total[p.id] = 0); }); periods.forEach(p => { data.net[p.id] = 0; data.available[p.id] = 0; }); const addToData = (item, periodId) => { if (periodId && data[item.segment]) { const amount = item.amountUSD || 0; if (!data[item.segment].concepts[item.category]) { data[item.segment].concepts[item.category] = {}; periods.forEach(p => data[item.segment].concepts[item.category][p.id] = 0); } if (data[item.segment].concepts[item.category][periodId] !== undefined) { data[item.segment].concepts[item.category][periodId] += amount; } data[item.segment].total[periodId] += amount; if (SEGMENTS[item.segment].type === 'income') { data.net[periodId] += amount; } else { data.net[periodId] -= amount; } } }; transactions.forEach(t => { const tDateStr = t.date.split('T')[0]; if (tDateStr < startDate || tDateStr > endDate) return; let pId = ""; if (granularity === 'daily') { pId = tDateStr; } else if (granularity === 'monthly') { pId = tDateStr.substring(0, 7); } else if (granularity === 'yearly') { pId = tDateStr.substring(0, 4); } else if (granularity === 'weekly') { const tTime = new Date(tDateStr + "T12:00:00").getTime(); const period = periods.find((p, i) => { if (granularity === 'weekly') { const pDate = new Date(p.id + "T12:00:00"); const nextPDate = new Date(pDate); nextPDate.setDate(nextPDate.getDate() + 7); return tTime >= pDate.getTime() && tTime < nextPDate.getTime(); } return false; }); if (period) pId = period.id; } addToData(t, pId); }); recurringRules.forEach(rule => { const ruleStart = new Date(rule.startDate + "T12:00:00"); const reportEnd = new Date(endDate + "T12:00:00"); let current = new Date(ruleStart); const todayStr = new Date().toISOString().split('T')[0]; while (current <= reportEnd) { const currentStr = current.toISOString().split('T')[0]; if (currentStr > todayStr && currentStr >= startDate) { let pId = ""; if (granularity === 'daily') pId = currentStr; else if (granularity === 'monthly') pId = currentStr.substring(0, 7); else if (granularity === 'yearly') pId = currentStr.substring(0, 4); addToData(rule, pId); } if (rule.frequency === 'daily') current.setDate(current.getDate() + 1); else if (rule.frequency === 'weekly') current.setDate(current.getDate() + 7); else if (rule.frequency === 'monthly') { current.setMonth(current.getMonth() + 1); } else if (rule.frequency === 'yearly') current.setFullYear(current.getFullYear() + 1); else break; } }); periods.forEach(p => { if(!p.id) return; const totalIncome = data.ingresos.total[p.id] || 0; const totalSavings = data.ahorro.total[p.id] || 0; const totalFixed = data.gastos_fijos.total[p.id] || 0; data.available[p.id] = (totalIncome - totalSavings) - totalFixed; }); return data; }, [transactions, recurringRules, periods, granularity, startDate, endDate, pnlStructure]);

            return React.createElement('div', { className: "h-full flex flex-col pt-[env(safe-area-inset-top)] bg-app-bg" },
                React.createElement('div', { className: "px-4 pb-4 bg-app-bg border-b border-white/5", style: { paddingTop: "calc(env(safe-area-inset-top) + 24px)" } },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                         React.createElement('select', { value: granularity, onChange: e => setGranularity(e.target.value), className: "bg-dark-highlight border border-white/10 text-white rounded-xl px-4 py-2 text-xs font-bold focus:outline-none min-w-[80px]" }, React.createElement('option', { value: "daily" }, "Diario"), React.createElement('option', { value: "weekly" }, "Semanal"), React.createElement('option', { value: "monthly" }, "Mensual"), React.createElement('option', { value: "yearly" }, "Anual")),
                         React.createElement('div', { className: "flex gap-2 items-center flex-1 justify-end" }, 
                             React.createElement('input', { type: "date", value: startDate, onChange: e => setStartDate(e.target.value), className: "w-24 bg-dark-highlight border border-white/10 text-white rounded-xl px-2 py-2 text-xs font-medium" }), 
                             React.createElement('span', { className: "text-gray-500 text-xs" }, "a"),
                             React.createElement('input', { type: "date", value: endDate, onChange: e => setEndDate(e.target.value), className: "w-24 bg-dark-highlight border border-white/10 text-white rounded-xl px-2 py-2 text-xs font-medium" })
                         )
                    )
                ),
                React.createElement('div', { className: "flex-1 overflow-auto bg-app-bg pnl-table-container pb-36" }, 
                    React.createElement('table', { className: "pnl-table" },
                        React.createElement('thead', null, React.createElement('tr', null, React.createElement('th', { className: "pnl-cell-head pnl-col-sticky" }, ""), periods.map(p => React.createElement('th', { key: p.id, className: "pnl-cell-head min-w-[80px]" }, p.label)))),
                        React.createElement('tbody', null,
                            ['ingresos', 'ahorro'].map(seg => React.createElement(React.Fragment, { key: seg }, React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-group-header" }, SEGMENTS[seg].label.toUpperCase()), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-group-header" }))), Object.entries(reportData[seg].concepts).map(([concept, values]) => React.createElement('tr', { key: concept }, React.createElement('td', { className: "pnl-cell pnl-col-sticky text-gray-400 pl-4" }, concept), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell" }, values[p.id] === 0 ? '-' : Math.round(values[p.id]).toLocaleString())))), React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-total text-white" }, `Total ${SEGMENTS[seg].label}`), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-total" }, Math.round(reportData[seg].total[p.id]).toLocaleString()))))),
                            React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-available" }, "DISPONIBLE"), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-available" }, Math.round(reportData.available[p.id]).toLocaleString()))),
                            ['gastos_fijos', 'gastos_variables'].map(seg => React.createElement(React.Fragment, { key: seg }, React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-group-header" }, SEGMENTS[seg].label.toUpperCase()), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-group-header" }))), Object.entries(reportData[seg].concepts).map(([concept, values]) => React.createElement('tr', { key: concept }, React.createElement('td', { className: "pnl-cell pnl-col-sticky text-gray-400 pl-4" }, concept), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell" }, values[p.id] === 0 ? '-' : Math.round(values[p.id]).toLocaleString())))), React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-total text-white" }, `Total ${SEGMENTS[seg].label}`), periods.map(p => React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-total" }, Math.round(reportData[seg].total[p.id]).toLocaleString()))))),
                            
                            // NUEVA FILA: TOTAL GASTOS (FIJOS + VARIABLES)
                            React.createElement('tr', null, 
                                React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-total text-white", style: { borderTop: '2px solid #333' } }, "TOTAL GASTOS (F+V)"), 
                                periods.map(p => {
                                    const totalF = reportData.gastos_fijos.total[p.id] || 0;
                                    const totalV = reportData.gastos_variables.total[p.id] || 0;
                                    return React.createElement('td', { key: p.id, className: "pnl-cell pnl-row-total", style: { borderTop: '2px solid #333' } }, Math.round(totalF + totalV).toLocaleString());
                                })
                            ),

                            React.createElement('tr', null, React.createElement('td', { colSpan: periods.length + 1, className: "h-4 bg-app-bg" })),
                            React.createElement('tr', null, React.createElement('td', { className: "pnl-cell pnl-col-sticky pnl-row-net" }, "RESULTADO NETO"), periods.map(p => React.createElement('td', { key: p.id, className: `pnl-cell pnl-row-net ${reportData.net[p.id] < 0 ? 'text-red-500' : 'text-emerald-400'}` }, Math.round(reportData.net[p.id]).toLocaleString())))
                        )
                    )
                )
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [rates, setRates] = useState({ bcv: 0, parallel: 0 }); // Init to 0
            const [transactions, setTransactions] = useState([]);
            const [recurringRules, setRecurringRules] = useState([]);
            const [pnlStructure, setPnlStructure] = useState(DEFAULT_PNL);
            const [budgets, setBudgets] = useState({}); // New budget state
            const [showTransactionModal, setShowTransactionModal] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [currentTab, setCurrentTab] = useState('home');
            const [editingTransaction, setEditingTransaction] = useState(null);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if(u) console.log("Usuario autenticado:", u.email);
                    else console.log("Usuario desconectado");
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                // ERROR HANDLER HELPER
                const handleSnapshotError = (err, context) => {
                    console.error(`Error in ${context}:`, err);
                    if (err.code === 'permission-denied') {
                        alert(`Error de permisos (${context}): No tienes acceso a esta base de datos.`);
                    }
                };

                // SAFE DB CHECK
                if (!db) {
                    alert("Error crítico: No hay conexión a la base de datos.");
                    return;
                }

                // PATHS CORREGIDOS: /projects/{PROJECT_DOC_ID}/users/{userId}/...
                const userRef = doc(db, ROOT_COLLECTION, PROJECT_DOC_ID, 'users', user.uid);
                const ratesRef = doc(userRef, 'settings', 'rates');
                const pnlRef = doc(userRef, 'settings', 'pnl');
                const budgetsRef = doc(userRef, 'settings', 'budgets');
                const transCol = collection(userRef, 'transactions');
                const recCol = collection(userRef, 'recurring');

                const unsubRates = onSnapshot(ratesRef, (doc) => { if (doc.exists()) setRates(doc.data()); }, (err) => handleSnapshotError(err, 'Rates'));
                
                getRatesFromAPI().then(async (newRates) => { 
                    if (newRates && newRates.bcv && newRates.parallel) { 
                        try {
                            await setDoc(ratesRef, newRates, { merge: true }); 
                        } catch(e) {
                            console.error("Error writing initial rates", e);
                        }
                    } 
                });
                
                const unsubPnl = onSnapshot(pnlRef, (doc) => { 
                    if (doc.exists()) setPnlStructure(doc.data()); 
                    else {
                        setDoc(pnlRef, DEFAULT_PNL).catch(e => console.error("Error creating default PnL", e));
                    }
                }, (err) => handleSnapshotError(err, 'PnL Config'));
                
                const unsubBudgets = onSnapshot(budgetsRef, (doc) => { if (doc.exists()) setBudgets(doc.data()); }, (err) => handleSnapshotError(err, 'Budgets'));

                const q = query(transCol);
                const unsubTrans = onSnapshot(q, (snapshot) => { 
                    let data = snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.profileId === 'personal');
                    data.sort((a, b) => new Date(b.date) - new Date(a.date)); 
                    setTransactions(data); 
                }, (err) => handleSnapshotError(err, 'Transactions'));
                
                const qRec = query(recCol);
                const unsubRec = onSnapshot(qRec, (snapshot) => { 
                    let data = snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.profileId === 'personal');
                    setRecurringRules(data); 
                }, (err) => handleSnapshotError(err, 'Recurring'));
                
                return () => { unsubRates(); unsubTrans(); unsubPnl(); unsubRec(); unsubBudgets(); };
            }, [user]);

            const updateRates = async (newRates) => { 
                if(!user) return; 
                try {
                    await setDoc(doc(db, ROOT_COLLECTION, PROJECT_DOC_ID, 'users', user.uid, 'settings', 'rates'), { bcv: parseFloat(newRates.bcv), parallel: parseFloat(newRates.parallel) }); 
                } catch(e) { alert("Error guardando tasas: " + e.message); }
            };
            
            const updatePnl = async (newPnl) => { 
                if(!user) return; 
                try {
                    await setDoc(doc(db, ROOT_COLLECTION, PROJECT_DOC_ID, 'users', user.uid, 'settings', 'pnl'), newPnl); 
                } catch(e) { alert("Error guardando config: " + e.message); }
            };
            
            const updateBudgets = async (newBudgets) => { 
                if(!user) return; 
                try {
                    await setDoc(doc(db, ROOT_COLLECTION, PROJECT_DOC_ID, 'users', user.uid, 'settings', 'budgets'), newBudgets); 
                } catch(e) { alert("Error guardando presupuesto: " + e.message); }
            };

            const handleEditTransaction = (tx) => {
                setEditingTransaction(tx);
                setShowTransactionModal(true);
            };

            const handleCloseModal = () => {
                setShowTransactionModal(false);
                setEditingTransaction(null);
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };

            if (!user) {
                return React.createElement(React.Fragment, null,
                    React.createElement(DebugPanel),
                    React.createElement(LoginScreen, { onLogin: () => {} })
                );
            }

            return React.createElement(ErrorBoundary, null, 
                React.createElement('div', { className: "h-screen w-full bg-app-bg flex flex-col text-white" },
                    React.createElement(DebugPanel),
                    React.createElement('div', { className: "flex-1 overflow-y-auto no-scrollbar" },
                        currentTab === 'home' ? React.createElement(HomeView, { rates, transactions, onUpdateRate: updateRates, onOpenAdd: () => setShowTransactionModal(true), onEditTransaction: handleEditTransaction, user, onLogout: handleLogout }) :
                        currentTab === 'history' ? React.createElement(HistoryView, { transactions, onEditTransaction: handleEditTransaction }) :
                        currentTab === 'report' ? React.createElement(PnLReportView, { transactions, pnlStructure, recurringRules }) : 
                        currentTab === 'budget' ? React.createElement(BudgetView, { pnlStructure, budgets, onUpdateBudgets: updateBudgets, transactions }) :
                        currentTab === 'config' ? React.createElement(ConfigView, { pnlData: pnlStructure, onUpdatePnl: updatePnl, userId: user.uid }) : null
                    ),

                    currentTab === 'home' && React.createElement('div', { className: "fixed bottom-24 right-6 z-40 safe-bottom animate-bounce-in" },
                        React.createElement('button', { onClick: () => setShowTransactionModal(true), className: "bg-brand text-black p-5 rounded-full shadow-2xl shadow-brand/40 hover:scale-105 transition-transform border border-white/20" }, React.createElement(Plus, { size: 28 }))
                    ),

                    React.createElement('nav', { className: "bg-dark-surface/90 backdrop-blur-xl border-t border-white/5 pb-safe pt-4 px-2 flex justify-around items-center z-30 safe-bottom fixed bottom-0 w-full" },
                        React.createElement('button', { 
                            onClick: () => setCurrentTab('home'), 
                            className: `p-4 rounded-2xl transition-all ${currentTab === 'home' ? 'text-brand bg-white/5' : 'text-gray-500 hover:text-gray-300'}` 
                        }, React.createElement(Home, { size: 28, strokeWidth: currentTab === 'home' ? 2.5 : 2 })),
                        
                        React.createElement('button', { 
                            onClick: () => setCurrentTab('budget'), 
                            className: `p-4 rounded-2xl transition-all ${currentTab === 'budget' ? 'text-brand bg-white/5' : 'text-gray-500 hover:text-gray-300'}` 
                        }, React.createElement(PieChart, { size: 28, strokeWidth: currentTab === 'budget' ? 2.5 : 2 })),

                        React.createElement('button', { 
                            onClick: () => setCurrentTab('history'), 
                            className: `p-4 rounded-2xl transition-all ${currentTab === 'history' ? 'text-brand bg-white/5' : 'text-gray-500 hover:text-gray-300'}` 
                        }, React.createElement(History, { size: 28, strokeWidth: currentTab === 'history' ? 2.5 : 2 })),
                        
                        React.createElement('button', { 
                            onClick: () => setCurrentTab('report'), 
                            className: `p-4 rounded-2xl transition-all ${currentTab === 'report' ? 'text-brand bg-white/5' : 'text-gray-500 hover:text-gray-300'}` 
                        }, React.createElement(FileSpreadsheet, { size: 28, strokeWidth: currentTab === 'report' ? 2.5 : 2 })),
                        
                        React.createElement('button', { 
                            onClick: () => setCurrentTab('config'), 
                            className: `p-4 rounded-2xl transition-all ${currentTab === 'config' ? 'text-brand bg-white/5' : 'text-gray-500 hover:text-gray-300'}` 
                        }, React.createElement(Settings, { size: 28, strokeWidth: currentTab === 'config' ? 2.5 : 2 }))
                    ),

                    showTransactionModal && React.createElement(TransactionModal, { 
                        onClose: handleCloseModal, 
                        rates, 
                        userId: user.uid, 
                        pnlStructure: pnlStructure, 
                        profileId: 'personal', 
                        initialData: editingTransaction,
                        projectDocId: PROJECT_DOC_ID 
                    })
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
