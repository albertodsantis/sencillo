<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="M&B Play">
    
    <!-- ICONO PERSONALIZADO (ONDAS DE AUDIO) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%234F46E5'/%3E%3Cpath fill='white' d='M144 368c-8.8 0-16-7.2-16-16V160c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16h-32zm112 64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v320c0 8.8-7.2 16-16 16h-32zm112-96c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v128c0 8.8-7.2 16-16 16h-32z'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%234F46E5'/%3E%3Cpath fill='white' d='M144 368c-8.8 0-16-7.2-16-16V160c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v192c0 8.8-7.2 16-16 16h-32zm112 64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v320c0 8.8-7.2 16-16 16h-32zm112-96c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v128c0 8.8-7.2 16-16 16h-32z'/%3E%3C/svg%3E">

    <!-- FUENTES DE GOOGLE -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rampart+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <title>M&B Play</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['"Rampart One"', 'cursive'],
                        'body': ['Quicksand', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            bg: '#111827',
                            card: '#1F2937', 
                            text: '#F3F4F6', 
                            textMuted: '#9CA3AF',
                            border: '#374151' 
                        }
                    }
                }
            }
        }
    </script>
    
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    <style>
        body { overscroll-behavior-y: none; }
        .ptr-element { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }
        /* Ocultar scrollbar pero permitir scroll */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans overflow-hidden dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Music, Heart, Radio, Calendar, BarChart3, Library, 
            Save, User, Shuffle, CheckCircle2, Clock, Headphones, 
            LogOut, Sparkles, SmilePlus, Mic2, Search, Loader2, 
            Share, PlusSquare, X, ExternalLink, RefreshCw, BellRing, Wrench, Settings, AlertCircle, Trophy, Star, Moon, Sun, StickyNote, Check, CheckCheck
        } from 'lucide-react';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            limit, 
            getDocs,
            updateDoc,
            addDoc, 
            deleteDoc,
            where,
            increment,
            writeBatch,
            deleteField,
            getDoc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBzbIz_VKis6nu1W7JWWeCSgLzBqJQ8HzY",
            authDomain: "magapp-19035.firebaseapp.com",
            projectId: "magapp-19035",
            storageBucket: "magapp-19035.firebasestorage.app",
            messagingSenderId: "1022326629606",
            appId: "1:1022326629606:web:ebea8e95dd233bc6560727"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTES ---
        const PLAYERS = {
            player_1: { id: 'player_1', name: 'Maga', phone: '584141501001', color: 'text-pink-600', bg: 'bg-pink-50', border: 'border-pink-200', countColor: 'bg-pink-100 text-pink-700', barColor: 'bg-pink-500' },
            player_2: { id: 'player_2', name: 'Beto', phone: '34675623927', color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200', countColor: 'bg-blue-100 text-blue-700', barColor: 'bg-blue-500' }
        };

        const EMOJIS = ["üíò", "üî•", "üòÇ", "üò≠", "ü•∞", "ü´†", "ü§Ø", "üíÉ", "üò¥", "ü•¥", "ü§Æ", "ü§°", "ü•∫", "üò°", "ü•∂", "ü•≥", "üëÄ", "üíÄ", "üí©", "ü´∂"];

        const DEFAULT_THEMES = [
            "Celebrar tus peque√±as victorias", "Cocinar con ritmo", "Nostalgia bonita", "Caminar como si tuvieras una misi√≥n", "Recordar tu infancia sin querer", 
            "Entrenar", "Viajar mentalmente a otro pa√≠s", "Manejar de noche", "Que todos se saben", "Necesito bailar", "Con groove funky", "Liberar estr√©s acumulado",
            "Antes de dormir", "Gritar en el coche", "Un domingo por la ma√±ana", "Con vibe latina", "Llorar", "Sentir que todo fluye", "Superar a tu ex", 
            "Instrumental para concentrarte", "Una noche melanc√≥lica mirando al techo", "Sentirte invencible", "Una noche tranquila", "Re√≠rte un poco",
            "Que te hace re√≠r", "Desahogarte", "Dedicar a alguien que amas", "Cinematogr√°fica", "Empezar un d√≠a desde cero", "Ac√∫stica para relajarte", 
            "Una noche de verano", "Bailar en la ducha sin verg√ºenza", "Un momento √≠ntimo", "Pensar en tu ex", "Sentirte poderoso", "Con piano que duele",
            "Que te enamora aunque est√©s soltero", "Mejorar el estado de √°nimo", "Un d√≠a de lluvia", "Sentir que eres el protagonista"
        ];

        const getTodayString = () => new Date().toISOString().split('T')[0];

        // --- API M√öSICA ---
        const searchMusic = async (term, type = 'song') => {
            if (!term || term.length < 2) return [];
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=${type === 'song' ? 'song' : 'musicArtist'}&limit=5`);
                if (!res.ok) return [];
                const data = await res.json();
                return data.results.map(item => ({
                    id: item.trackId || item.artistId,
                    title: type === 'song' ? item.trackName : item.artistName,
                    subtitle: type === 'song' ? item.artistName : (item.primaryGenreName || 'Artista'),
                    artist: item.artistName,
                    track: item.trackName
                }));
            } catch (e) { return []; }
        };

        // --- COMPONENTES UI ---
        const PullToRefresh = ({ children }) => {
             const [startPoint, setStartPoint] = useState(0);
             const [pullChange, setPullChange] = useState(0);
             const [refreshing, setRefreshing] = useState(false);
             const containerRef = useRef(null);

             const initLoading = () => {
                 setRefreshing(true);
                 setTimeout(() => { setRefreshing(false); setPullChange(0); window.location.reload(); }, 800);
             };
             const onTouchStart = (e) => { if (containerRef.current?.scrollTop === 0) setStartPoint(e.targetTouches[0].clientY); };
             const onTouchMove = (e) => {
                 if (!startPoint) return;
                 const pullLength = e.targetTouches[0].clientY - startPoint;
                 if (containerRef.current?.scrollTop === 0 && pullLength > 0) setPullChange(pullLength * 0.4);
             };
             const onTouchEnd = () => {
                 if (!startPoint) return;
                 if (pullChange > 70) initLoading(); else setPullChange(0);
                 setStartPoint(0);
             };

             return React.createElement('div', {
                 ref: containerRef,
                 className: "flex-1 overflow-y-auto scrollbar-hide relative h-full",
                 onTouchStart, onTouchMove, onTouchEnd,
                 style: { overscrollBehavior: 'contain' }
             }, 
                 React.createElement('div', {
                     className: "absolute top-0 left-0 w-full flex justify-center pointer-events-none z-20",
                     style: { 
                         transform: `translateY(${refreshing ? 20 + (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-top') || 0)) : pullChange - 50}px)`,
                         opacity: refreshing ? 1 : Math.min(pullChange / 50, 1),
                         transition: !startPoint ? 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s' : 'none'
                     }
                 }, React.createElement('div', { className: "bg-white p-2.5 rounded-full shadow-lg border border-indigo-100 text-indigo-600" }, React.createElement(Loader2, { className: `animate-spin`, size: 22 }))),
                 React.createElement('div', { className: "min-h-full", style: { transform: `translateY(${refreshing ? 60 : pullChange}px)`, transition: !startPoint ? 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)' : 'none' } }, children)
             );
         };

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
            const variants = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-md shadow-indigo-200 dark:shadow-none",
                secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 dark:bg-dark-card dark:text-dark-text dark:border-dark-border dark:hover:bg-gray-800",
                danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400 dark:border-red-900/30",
                ghost: "text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800",
                outline: "border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50 dark:border-indigo-900 dark:text-indigo-400",
                spotify: "bg-green-500 text-white hover:bg-green-600 shadow-md shadow-green-200 dark:shadow-none",
                whatsapp: "bg-[#25D366] text-white hover:bg-[#20bd5a] shadow-md shadow-green-100 dark:shadow-none",
                success: "bg-emerald-500 text-white hover:bg-emerald-600 shadow-md shadow-emerald-200 dark:shadow-none" 
            };
            return React.createElement('button', { 
                onClick, disabled, 
                className: `px-4 py-3 rounded-xl font-medium transition-transform active:scale-95 flex items-center justify-center gap-2 touch-manipulation select-none ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`,
                style: { WebkitTapHighlightColor: 'transparent' }
            }, children);
        };

        const PredictiveInput = ({ label, value, onChange, onSelect, placeholder, type = 'song' }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [loading, setLoading] = useState(false);
            const wrapperRef = useRef(null);
            useEffect(() => {
                const timer = setTimeout(async () => {
                    if (value.length >= 2) {
                        setLoading(true);
                        const results = await searchMusic(value, type);
                        setSuggestions(results);
                        setLoading(false);
                    } else { setSuggestions([]); }
                }, 500);
                return () => clearTimeout(timer);
            }, [value]);

            return React.createElement('div', { className: "mb-4 relative", ref: wrapperRef },
                label && React.createElement('label', { className: "block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 ml-1" }, label),
                React.createElement('div', { className: "relative" },
                    React.createElement('input', {
                        type: "text", value,
                        onChange: (e) => onChange(e.target.value),
                        placeholder,
                        className: "w-full p-3.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition bg-white text-base shadow-sm dark:bg-dark-card dark:border-dark-border dark:text-white",
                        autoComplete: "off"
                    }),
                    React.createElement('div', { className: "absolute left-3 top-3.5 text-gray-400 pointer-events-none" },
                        loading ? React.createElement(Loader2, { size: 20, className: "animate-spin text-indigo-500" }) : React.createElement(Search, { size: 20 })
                    )
                ),
                suggestions.length > 0 && React.createElement('div', { className: "absolute z-50 w-full bg-white dark:bg-dark-card mt-1 rounded-xl shadow-xl border border-gray-100 dark:border-dark-border overflow-hidden max-h-60 overflow-y-auto" },
                    suggestions.map((item, idx) => React.createElement('div', {
                        key: `${item.id}-${idx}`,
                        onClick: () => { onChange(item.title); setSuggestions([]); if (onSelect) onSelect(item); },
                        className: "p-3 hover:bg-indigo-50 dark:hover:bg-gray-800 cursor-pointer border-b border-gray-50 dark:border-gray-800 last:border-0 transition-colors flex flex-col"
                    },
                        React.createElement('span', { className: "font-bold text-gray-800 dark:text-gray-200 text-sm" }, item.title),
                        React.createElement('span', { className: "text-xs text-gray-500 dark:text-gray-400" }, item.subtitle)
                    ))
                )
            );
        };

        // --- PANTALLAS ---

        const InstallPrompt = () => {
             return null; 
        };

        const LoginScreen = ({ onLogin }) => {
            return React.createElement('div', { className: "min-h-[100dvh] flex flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50 to-pink-50 animate-in fade-in duration-500 dark:from-gray-900 dark:to-gray-800" },
                React.createElement('div', { className: "bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-8 rounded-3xl shadow-xl max-w-sm w-full text-center border border-white/50 dark:border-gray-700" },
                    React.createElement('div', { className: "w-20 h-20 bg-indigo-100 dark:bg-gray-700 rounded-2xl flex items-center justify-center mx-auto mb-6 text-indigo-600 dark:text-indigo-400 shadow-inner" },
                        React.createElement('span', { className: "material-symbols-outlined", style: { fontSize: '48px' } }, "edit_audio")
                    ),
                    React.createElement('h1', { className: "text-5xl font-display mb-2 tracking-tight bg-gradient-to-r from-pink-500 to-indigo-600 bg-clip-text text-transparent leading-tight pb-2" }, "M&B Play"),
                    React.createElement('p', { className: "text-base font-body text-indigo-400 mb-8 font-bold" }, "Construyendo nuestro Soundtrack"),
                    React.createElement('p', { className: "mb-4 text-gray-400 dark:text-gray-500 font-bold uppercase text-xs tracking-widest" }, "¬øQui√©n eres?"),
                    React.createElement('div', { className: "space-y-3" },
                        React.createElement('button', { onClick: () => onLogin(PLAYERS.player_1.id), className: "w-full p-4 rounded-xl border-2 border-pink-100 bg-pink-50/50 text-pink-700 font-bold text-lg active:scale-95 transition-transform touch-manipulation font-body dark:bg-pink-900/20 dark:border-pink-800 dark:text-pink-300" }, "Maga"),
                        React.createElement('button', { onClick: () => onLogin(PLAYERS.player_2.id), className: "w-full p-4 rounded-xl border-2 border-blue-100 bg-blue-50/50 text-blue-700 font-bold text-lg active:scale-95 transition-transform touch-manipulation font-body dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-300" }, "Beto")
                    )
                )
            );
        };

        const ProfileScreen = ({ userRole, onLogout, onFixCounters, stats, userId }) => {
            const player = PLAYERS[userRole];
            const [darkMode, setDarkMode] = useState(() => document.documentElement.classList.contains('dark'));
            const [notes, setNotes] = useState('');
            const [isSavingNotes, setIsSavingNotes] = useState(false);
            
            useEffect(() => {
                if(!userId) return;
                getDoc(doc(db, 'user_notes', userId)).then(snap => {
                    if(snap.exists()) setNotes(snap.data().content || '');
                });
            }, [userId]);

            const toggleDarkMode = () => {
                const newMode = !darkMode;
                setDarkMode(newMode);
                if (newMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('mb_theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('mb_theme', 'light');
                }
            };

            const saveNotes = async () => {
                if(!userId) return;
                setIsSavingNotes(true);
                await setDoc(doc(db, 'user_notes', userId), { content: notes }, { merge: true });
                setIsSavingNotes(false);
            };

            const userTotal = stats ? (userRole === 'player_1' ? stats.totalMaga : stats.totalBeto) : 0;
            const listenedTotal = stats ? (userRole === 'player_1' ? stats.listenedByMaga : stats.listenedByBeto) : 0; 
            
            let userTitle = "Mel√≥mano Principiante";
            if (userTotal > 5) userTitle = "Selector de √âxitos";
            if (userTotal > 20) userTitle = "Curador Oficial";
            if (userTotal > 50) userTitle = "Leyenda del Audio";

            return React.createElement('div', { className: "px-5 pb-32 space-y-6 pt-[calc(1.25rem+env(safe-area-inset-top))]" },
                React.createElement('header', { className: "flex items-center justify-between pt-2 mb-6" },
                    React.createElement('div', null,
                        React.createElement('h1', { className: "text-4xl font-display text-gray-900 dark:text-white tracking-tight" }, "Tu Perfil"),
                        React.createElement('p', { className: "text-gray-500 dark:text-gray-400 font-medium font-body" }, `Hola, ${player.name}`)
                    ),
                    React.createElement('div', { className: `w-12 h-12 rounded-2xl border shadow-sm flex items-center justify-center ${player.bg} ${player.border} dark:bg-gray-800 dark:border-gray-700` },
                        React.createElement(User, { size: 24, className: player.color.split(' ')[0] }) 
                    )
                ),
                
                React.createElement('div', { className: "bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-3xl shadow-lg text-white relative overflow-hidden" },
                    React.createElement(Sparkles, { className: "absolute top-4 right-4 text-white/20", size: 48 }),
                    React.createElement(Music, { className: "absolute -bottom-6 -left-4 text-white/10", size: 120 }),
                    React.createElement('h3', { className: "text-xs font-bold uppercase tracking-widest opacity-80 mb-4" }, "Estad√≠sticas Personales"),
                    React.createElement('div', { className: "flex gap-8" },
                         React.createElement('div', { className: "flex flex-col gap-1" },
                            React.createElement('span', { className: "text-4xl font-display tracking-tight" }, userTotal),
                            React.createElement('span', { className: "text-xs font-medium opacity-90 uppercase" }, "Compartidas")
                        ),
                        React.createElement('div', { className: "flex flex-col gap-1" },
                            React.createElement('span', { className: "text-4xl font-display tracking-tight" }, listenedTotal),
                            React.createElement('span', { className: "text-xs font-medium opacity-90 uppercase" }, "Escuchadas")
                        )
                    ),
                    React.createElement('div', { className: "mt-6 pt-4 border-t border-white/20 flex items-center gap-3" },
                        React.createElement(Trophy, { size: 20, className: "text-yellow-300" }),
                        React.createElement('div', null,
                            React.createElement('p', { className: "text-[10px] uppercase font-bold opacity-70" }, "Rango Actual"),
                            React.createElement('p', { className: "font-bold text-lg leading-none" }, userTitle)
                        )
                    )
                ),
                
                React.createElement('div', { className: "bg-white dark:bg-dark-card p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-dark-border" },
                    React.createElement('h3', { className: "text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider flex items-center justify-between" }, 
                        React.createElement('span', { className: "flex items-center gap-2" }, React.createElement(StickyNote, { size: 14 }), "Notas Personales"),
                        isSavingNotes && React.createElement('span', { className: "text-green-500 text-[10px]" }, "Guardando...")
                    ),
                    React.createElement('textarea', {
                        value: notes,
                        onChange: (e) => setNotes(e.target.value),
                        onBlur: saveNotes, 
                        placeholder: "Anota aqu√≠ ideas de canciones o tem√°ticas futuras...",
                        className: "w-full h-24 p-3 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none dark:text-white",
                    })
                ),

                React.createElement('div', { className: "bg-white dark:bg-dark-card p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-dark-border" },
                    React.createElement('h3', { className: "text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider flex items-center gap-2" }, 
                        React.createElement(Settings, { size: 14 }), "Configuraci√≥n"
                    ),
                    React.createElement('div', { className: "flex flex-col gap-3" },
                        React.createElement('button', { 
                            onClick: toggleDarkMode,
                            className: "w-full py-3 px-4 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 flex items-center justify-between transition-colors"
                        }, 
                            React.createElement('span', { className: "text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2" }, 
                                darkMode ? React.createElement(Moon, { size: 16 }) : React.createElement(Sun, { size: 16 }), "Modo Oscuro"
                            ),
                            React.createElement('div', { className: `w-10 h-5 rounded-full p-1 transition-colors ${darkMode ? 'bg-indigo-500' : 'bg-gray-300'}` },
                                React.createElement('div', { className: `bg-white w-3 h-3 rounded-full shadow-sm transform transition-transform ${darkMode ? 'translate-x-5' : ''}` })
                            )
                        ),
                        React.createElement(Button, { onClick: onFixCounters, variant: "secondary", className: "w-full py-3 text-sm" }, 
                            React.createElement(Wrench, { size: 16 }), " Reparar y Migrar"
                        ),
                        React.createElement(Button, { onClick: onLogout, variant: "danger", className: "w-full py-3 font-body" }, 
                            React.createElement(LogOut, { size: 18 }), " Cerrar Sesi√≥n"
                        )
                    )
                ),
                
                React.createElement('div', { className: "py-8 opacity-40 flex flex-col items-center justify-center gap-2" },
                    React.createElement('span', { className: "material-symbols-outlined text-gray-400", style: { fontSize: '32px' } }, "edit_audio"),
                    React.createElement('p', { className: "text-center text-gray-400 text-xs font-medium uppercase tracking-widest font-body" }, "M&B Play v4.1")
                )
            );
        };

        const TodayScreen = ({ entry, userRole, onUpdateEntry, onSongSubmit, onDeselectTheme }) => {
            const [localSong, setLocalSong] = useState('');
            const [localArtist, setLocalArtist] = useState('');
            const [localComment, setLocalComment] = useState('');
            
            const otherRole = userRole === 'player_1' ? 'player_2' : 'player_1';
            if (!PLAYERS[userRole] || !PLAYERS[otherRole]) return null;

            const myData = entry?.players?.[userRole] || {};
            const otherData = entry?.players?.[otherRole] || {};
            const isSubmitted = (myData.status === 'enviado' || myData.status === 'escuchado') && myData.song_title;
            const isOtherSongSubmitted = otherData.status === 'enviado' || otherData.status === 'escuchado';
            const isOtherSongListened = otherData.status === 'escuchado';

            const otherTheme = otherData.theme_name;
            const shouldNudge = !otherTheme || !otherData.song_title;
            
            const handleNudge = () => {
                let text;
                const appLink = window.location.href; 
                const targetPhone = PLAYERS[otherRole].phone;

                if (myData.song_title) {
                    text = `¬°Ya eleg√≠ mi canci√≥n para la tem√°tica *"${myData.theme_name}"*! üéµ Es un temazo... ü§´\n\nEntra a M&B Play para descubrirla y reaccionar: ${appLink}`;
                } else {
                    text = `¬°Epa! üéµ Te estamos esperando en M&B Play. ¬øCu√°l es tu canci√≥n de hoy? Entra aqu√≠: ${appLink}`;
                }
                const url = `https://wa.me/${targetPhone}?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            };

            useEffect(() => {
                if (myData) {
                    setLocalSong(myData.song_title || '');
                    setLocalArtist(myData.artist || '');
                    setLocalComment(myData.comment || '');
                }
            }, [entry]); 

            const handleSubmit = () => {
                if (!localSong || !localArtist) return;
                const spotifyLink = `https://open.spotify.com/search/${encodeURIComponent(localSong + " " + localArtist)}`;
                onSongSubmit({
                    song_title: localSong,
                    artist: localArtist,
                    comment: localComment,
                    spotify_link: spotifyLink
                });
            };

            const handleReaction = (emoji) => {
                onUpdateEntry({
                    [`players.${userRole}.reaction_emoji`]: emoji,
                    [`players.${userRole}.status`]: 'escuchado' 
                });
            };

            const handleMarkListened = () => {
                 onUpdateEntry({
                    [`players.${otherRole}.status`]: 'escuchado'
                });
            };

            const handleSongSelect = (item) => {
                if (item.artist) setLocalArtist(item.artist);
            };

            if (!myData.theme_name) return React.createElement('div', { className: "p-8 text-center text-gray-500 dark:text-gray-400 pt-[calc(40vh)]" }, 
                React.createElement('div', { className: "flex flex-col items-center gap-4 animate-in fade-in zoom-in duration-500"},
                    React.createElement(Library, { size: 64, className: "text-indigo-200 dark:text-indigo-800" }),
                    React.createElement('h3', { className: "text-xl font-bold text-gray-800 dark:text-white" }, "Sin Tem√°tica"),
                    React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400 max-w-xs mx-auto" }, "Primero selecciona de qu√© va la canci√≥n de hoy en la pesta√±a Temas.")
                )
            );

            return React.createElement('div', { className: "px-5 pb-32 space-y-6 pt-[calc(1.25rem+env(safe-area-inset-top))]" },
                React.createElement('div', { className: `p-6 rounded-3xl border-2 ${PLAYERS[userRole].border} ${PLAYERS[userRole].bg} dark:bg-gray-800 dark:border-gray-700 shadow-sm relative` },
                    React.createElement('div', { className: "mb-5" },
                        React.createElement('h3', { className: `font-bold text-lg flex items-center gap-2 ${PLAYERS[userRole].color} mb-3` }, React.createElement(User, { size: 20 }), " Tu Turno"),
                        React.createElement('div', { className: "bg-white/70 dark:bg-gray-900/50 p-4 rounded-2xl border border-white/60 dark:border-gray-600 text-center shadow-sm relative" },
                            React.createElement('span', { className: "text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block" }, "Tem√°tica"),
                            React.createElement('span', { className: "text-xl font-bold text-gray-800 dark:text-white leading-tight font-body" }, myData.theme_name),
                            !isSubmitted && React.createElement('button', { onClick: onDeselectTheme, className: "absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1 transition-colors", title: "Cambiar tem√°tica" }, React.createElement(X, { size: 16 }))
                        )
                    ),
                    !isSubmitted ? React.createElement('div', { className: "space-y-4" },
                        React.createElement(PredictiveInput, { label: "Canci√≥n", value: localSong, onChange: setLocalSong, onSelect: handleSongSelect, placeholder: "", type: "song" }),
                        React.createElement(PredictiveInput, { label: "Artista", value: localArtist, onChange: setLocalArtist, placeholder: "", type: "artist" }),
                        React.createElement('div', { className: "mb-2" },
                            React.createElement('label', { className: "block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 ml-1" }, "Comentario"),
                            React.createElement('textarea', { value: localComment, onChange: (e) => setLocalComment(e.target.value), className: "w-full p-3.5 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none bg-white text-base shadow-sm min-h-[80px] font-body dark:bg-dark-card dark:border-dark-border dark:text-white", rows: "2", placeholder: "" })
                        ),
                        React.createElement(Button, { onClick: handleSubmit, className: "w-full py-4 text-lg shadow-md mt-2 font-body font-bold" }, "Enviar Canci√≥n")
                    ) : React.createElement('div', { className: "text-center py-6 relative" },
                        React.createElement('div', { className: "w-14 h-14 bg-white dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4 text-green-500 shadow-md" }, React.createElement(CheckCircle2, { size: 32 })),
                        React.createElement('h4', { className: "font-bold text-gray-800 dark:text-white text-xl mb-1 font-body" }, localSong),
                        React.createElement('p', { className: "text-gray-600 dark:text-gray-300 font-medium" }, localArtist),
                        myData.spotify_link && React.createElement('a', { href: myData.spotify_link, target: "_blank", rel: "noopener noreferrer", className: "inline-flex items-center gap-2 mt-4 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md transition-colors font-body" }, React.createElement(ExternalLink, { size: 14 }), "Abrir en Spotify"),
                        localComment && React.createElement('p', { className: "mt-4 text-sm text-gray-500 italic bg-white/50 dark:bg-gray-700/50 p-3 rounded-lg inline-block font-body dark:text-gray-300" }, `"${localComment}"`),
                        React.createElement('button', { onClick: () => onUpdateEntry({[`players.${userRole}.status`]: 'pendiente'}), className: "block w-full mt-6 text-xs text-gray-400 font-bold uppercase tracking-widest underline p-2" }, "Editar env√≠o"),
                        otherData.reaction_emoji && React.createElement('div', { className: "absolute -bottom-2 -right-2 bg-white dark:bg-gray-800 rounded-full p-2 shadow-lg border border-gray-100 dark:border-gray-700 text-3xl animate-bounce-slow", style: { animationDuration: '3s' } }, otherData.reaction_emoji)
                    )
                ),

                React.createElement('div', { className: `p-6 rounded-3xl border-2 ${PLAYERS[otherRole].border} bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm relative` },
                    React.createElement('div', { className: "mb-5" },
                        React.createElement('h3', { className: `font-bold text-lg flex items-center gap-2 ${PLAYERS[otherRole].color} mb-3` }, React.createElement(Headphones, { size: 20 }), ` ${PLAYERS[otherRole].name}`),
                        otherData.theme_name ? React.createElement('div', { className: "bg-gray-50 dark:bg-gray-700 p-3 rounded-xl border border-gray-100 dark:border-gray-600 text-center" },
                            React.createElement('span', { className: "text-[10px] font-bold text-gray-400 dark:text-gray-300 uppercase tracking-widest mb-1 block" }, "Tem√°tica"),
                            React.createElement('span', { className: "text-base font-bold text-gray-700 dark:text-white leading-tight font-body" }, otherData.theme_name)
                        ) : React.createElement('div', { className: "bg-gray-50 dark:bg-gray-700 p-3 rounded-xl border border-gray-100 dark:border-gray-600 text-center opacity-60" },
                            React.createElement('span', { className: "text-sm text-gray-500 dark:text-gray-400 font-medium" }, "Sin tem√°tica a√∫n")
                        )
                    ),
                    isOtherSongSubmitted ? React.createElement('div', { className: "text-center pb-12" },
                        React.createElement('h4', { className: "font-bold text-gray-800 text-xl mb-1 font-body" }, otherData.song_title),
                        React.createElement('p', { className: "text-gray-600 font-medium mb-4" }, otherData.artist),
                        otherData.spotify_link && React.createElement('a', { href: otherData.spotify_link, target: "_blank", rel: "noopener noreferrer", className: "inline-flex items-center gap-2 mb-6 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md transition-colors font-body" }, React.createElement(ExternalLink, { size: 14 }), "Abrir en Spotify"),
                        
                        !isOtherSongListened && React.createElement('div', { className: "mb-6" },
                             React.createElement(Button, { onClick: handleMarkListened, variant: "success", className: "w-full py-3 text-sm font-bold" }, React.createElement(Headphones, { size: 16 }), " Marcar como Escuchada")
                        ),
                        isOtherSongListened && React.createElement('div', { className: "mb-6 flex justify-center" },
                             React.createElement('span', { className: "bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1" }, React.createElement(Check, { size: 14 }), " Escuchada")
                        ),

                        otherData.comment && React.createElement('div', { className: "bg-gray-50 dark:bg-gray-700 p-4 rounded-2xl mb-2 text-sm text-gray-600 dark:text-gray-300 italic relative text-left inline-block w-full" },
                            React.createElement('span', { className: "text-2xl text-gray-300 absolute -top-2 left-2 font-serif" }, "‚Äú"),
                            React.createElement('p', { className: "pl-2 relative z-10 font-body" }, otherData.comment),
                            myData.reaction_emoji && React.createElement('div', { className: "absolute -bottom-4 -right-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-600 rounded-full px-2 py-1 shadow-md text-xl z-20 transition-all transform scale-100" }, myData.reaction_emoji)
                        ),
                        !otherData.comment && myData.reaction_emoji && React.createElement('div', { className: "absolute bottom-16 right-6 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-600 rounded-full px-2 py-1 shadow-md text-xl z-20" }, myData.reaction_emoji),
                        React.createElement('div', { className: "absolute bottom-4 left-0 w-full flex justify-center" },
                            React.createElement('div', { className: "bg-white/90 dark:bg-gray-800/90 backdrop-blur border border-gray-200 dark:border-gray-700 rounded-full shadow-lg px-3 py-2 flex gap-2 items-center overflow-x-auto max-w-[90%] scrollbar-hide" },
                                EMOJIS.map(emoji => React.createElement('button', {
                                    key: emoji,
                                    onClick: () => handleReaction(emoji),
                                    className: `text-2xl p-1.5 rounded-full transition-all active:scale-90 hover:bg-gray-100 dark:hover:bg-gray-700 ${myData.reaction_emoji === emoji ? 'bg-indigo-100 dark:bg-indigo-900 scale-110' : ''}`,
                                    style: { WebkitTapHighlightColor: 'transparent' }
                                }, emoji))
                            )
                        )
                    ) : React.createElement('div', { className: "text-center py-10 text-gray-400 flex flex-col items-center" },
                        React.createElement(Loader2, { className: "loader mb-4 border-4 w-8 h-8 text-indigo-200" }),
                        React.createElement('p', { className: "font-medium" }, `Esperando a ${PLAYERS[otherRole].name}...`)
                    )
                ),
                
                shouldNudge && React.createElement('div', { className: "mt-4" },
                    React.createElement(Button, { onClick: handleNudge, variant: "whatsapp", className: "w-full py-3 text-sm font-bold font-body" }, 
                        React.createElement(BellRing, { size: 18 }), ` Avisar a ${PLAYERS[otherRole].name}`
                    )
                )
            );
        };

        const ThemesScreen = ({ themes, onSelectTheme, onAddTheme, onToggleTheme, userRole }) => {
            const [newTheme, setNewTheme] = useState('');
            const player = PLAYERS[userRole];
            const handleAdd = () => {
                if(!newTheme.trim()) return;
                onAddTheme(newTheme);
                setNewTheme('');
            };

            return React.createElement('div', { className: "px-5 pb-32 space-y-6 pt-[calc(1.25rem+env(safe-area-inset-top))]" },
                React.createElement('header', null,
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-900 dark:text-white font-display" }, "Biblioteca de Temas"),
                    React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400 font-medium font-body" }, "Selecciona una tarjeta para elegir")
                ),

                React.createElement('div', { className: "bg-white dark:bg-dark-card p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-dark-border mb-6" },
                    React.createElement('h3', { className: "text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider" }, "Selecci√≥n R√°pida"),
                    React.createElement('div', { className: "grid grid-cols-1 gap-3" },
                        React.createElement(Button, { onClick: () => onSelectTheme(null, true), className: "w-full py-5 bg-gradient-to-r from-pink-500 to-indigo-500 border-none shadow-lg shadow-indigo-200 dark:shadow-none text-lg font-body font-bold" }, React.createElement(Shuffle, { size: 22 }), " ¬°Sorpr√©ndeme!")
                    )
                ),
                React.createElement('div', { className: "bg-white dark:bg-dark-card p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-dark-border" },
                    React.createElement('h3', { className: "text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider" }, "Crear Nueva"),
                    React.createElement('div', { className: "flex gap-3" },
                        React.createElement('input', { type: "text", value: newTheme, onChange: (e) => setNewTheme(e.target.value), className: "flex-1 p-3 rounded-xl border border-gray-300 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 text-base font-body dark:bg-gray-800 dark:border-gray-700 dark:text-white", placeholder: "Ej. Lluvia en Madrid" }),
                        React.createElement(Button, { onClick: handleAdd, className: "py-3 px-4" }, React.createElement(Save, { size: 20 }))
                    )
                ),
                React.createElement('div', { className: "space-y-3" },
                    React.createElement('div', { className: "flex items-center justify-between px-3 mb-2" },
                        React.createElement('div', { className: "flex-1" }),
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement('div', { className: "w-8 text-center text-[10px] font-bold text-pink-400 uppercase tracking-widest" }, "Maga"),
                            React.createElement('div', { className: "w-8 text-center text-[10px] font-bold text-blue-400 uppercase tracking-widest" }, "Beto")
                        )
                    ),
                    themes.map(theme => React.createElement('div', { 
                        key: theme.id, 
                        onClick: () => onSelectTheme(theme), 
                        className: `p-4 rounded-xl flex items-center justify-between border transition-all cursor-pointer active:scale-95 
                            ${theme.isSelected ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 shadow-md ring-1 ring-indigo-200 dark:ring-indigo-800 order-first' : 'bg-white dark:bg-dark-card border-gray-200 dark:border-dark-border hover:border-indigo-100'}` 
                    },
                        React.createElement('div', { className: "flex-1 pr-3" },
                            React.createElement('p', { className: `font-medium text-sm ${theme.isSelected ? 'text-indigo-700 dark:text-indigo-300 font-bold' : 'text-gray-700 dark:text-gray-200'} font-body leading-tight` }, theme.name),
                            theme.isSelected && React.createElement('span', { className: "text-[10px] text-indigo-500 dark:text-indigo-400 font-bold uppercase tracking-wider mt-1 block animate-in fade-in" }, "SELECCIONADO")
                        ),
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement('div', { className: `w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${PLAYERS.player_1.countColor} dark:bg-pink-900/30 dark:text-pink-300` }, theme.usage_player_1 || 0),
                            React.createElement('div', { className: `w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${PLAYERS.player_2.countColor} dark:bg-blue-900/30 dark:text-blue-300` }, theme.usage_player_2 || 0)
                        )
                    ))
                )
            );
        };

        const StatsScreen = ({ userId }) => {
            const [stats, setStats] = useState(null);
            const [history, setHistory] = useState([]);

            useEffect(() => {
                if (!userId) return;
                const q = query(collection(db, 'daily_entries'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    let totalMaga = 0, totalBeto = 0, hits = [], artists = {}, emojiStats = {};

                    data.forEach(d => {
                        const p1 = d.players?.player_1, p2 = d.players?.player_2;
                        
                        if (p1?.song_title) totalMaga++;
                        if (p2?.song_title) totalBeto++;
                        
                        if (p1?.reaction_emoji) {
                            if (!emojiStats[p1.reaction_emoji]) emojiStats[p1.reaction_emoji] = { p1: 0, p2: 0 };
                            emojiStats[p1.reaction_emoji].p1++;
                        }
                        if (p2?.reaction_emoji) {
                            if (!emojiStats[p2.reaction_emoji]) emojiStats[p2.reaction_emoji] = { p1: 0, p2: 0 };
                            emojiStats[p2.reaction_emoji].p2++;
                        }

                        [p1, p2].forEach(p => {
                            if (p?.artist) {
                                const normArtist = p.artist.trim().toLowerCase();
                                if (!artists[normArtist]) artists[normArtist] = { count: 0, name: p.artist.trim() };
                                artists[normArtist].count++;
                            }
                        });
                    });

                    const chartData = Object.entries(emojiStats).map(([emoji, counts]) => ({ emoji, p1: counts.p1, p2: counts.p2, total: counts.p1 + counts.p2 })).sort((a, b) => b.total - a.total).slice(0, 6);
                    const maxTotal = Math.max(...chartData.map(d => d.total), 1);
                    
                    const sortedHistory = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
                    setHistory(sortedHistory);
                    setStats({ totalMaga, totalBeto, chartData, maxTotal, hits: hits.reverse().slice(0, 20) });
                });
                return () => unsubscribe();
            }, [userId]);

            if (!stats) return React.createElement('div', { className: "p-8 text-center flex justify-center" }, React.createElement(Loader2, { className: "loader border-4 w-8 h-8 text-indigo-300" }));

            return React.createElement('div', { className: "px-5 pb-32 space-y-5 pt-[calc(1.25rem+env(safe-area-inset-top))]" },
                React.createElement('h2', { className: "text-2xl font-bold text-gray-900 dark:text-white font-display" }, "Resumen Hist√≥rico"),
                React.createElement('div', { className: "flex gap-4 justify-between" },
                    React.createElement('div', { className: "flex-1 bg-pink-50 dark:bg-pink-900/20 text-pink-700 dark:text-pink-300 p-6 rounded-2xl border border-pink-100 dark:border-pink-800 flex flex-col justify-center items-center shadow-sm" },
                        React.createElement('p', { className: "text-xs font-bold uppercase tracking-widest opacity-70 mb-2" }, "Maga"),
                        React.createElement('p', { className: "text-5xl font-display tracking-tight" }, stats.totalMaga)
                    ),
                    React.createElement('div', { className: "flex-1 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 p-6 rounded-2xl border border-blue-100 dark:border-blue-800 flex flex-col justify-center items-center shadow-sm" },
                        React.createElement('p', { className: "text-xs font-bold uppercase tracking-widest opacity-70 mb-2" }, "Beto"),
                        React.createElement('p', { className: "text-5xl font-display tracking-tight" }, stats.totalBeto)
                    )
                ),
                
                React.createElement('div', { className: "bg-white dark:bg-dark-card p-6 rounded-3xl shadow-lg border border-gray-100 dark:border-dark-border" },
                    React.createElement('h3', { className: "font-bold text-gray-700 dark:text-gray-200 mb-6 flex items-center gap-2" }, React.createElement(Sparkles, { size: 18, className: "text-yellow-500 fill-current" }), " Vibe Check"),
                    React.createElement('div', { className: "h-48 flex items-end justify-between gap-2 sm:gap-4" },
                        stats.chartData.length === 0 ? React.createElement('p', { className: "w-full text-center text-gray-400 text-sm py-10" }, "A√∫n no hay reacciones.") :
                        stats.chartData.map((data, idx) => {
                            const totalHeightPct = (data.total / stats.maxTotal) * 100;
                            const p1Pct = (data.p1 / data.total) * 100;
                            const p2Pct = (data.p2 / data.total) * 100;
                            return React.createElement('div', { key: idx, className: "flex flex-col items-center flex-1 h-full justify-end group" },
                                React.createElement('div', { className: "mb-1 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] font-bold text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-1 rounded absolute -mt-6" }, data.total),
                                React.createElement('div', { className: "w-full max-w-[30px] rounded-t-lg overflow-hidden flex flex-col-reverse relative transition-all hover:scale-105", style: { height: `${totalHeightPct}%` } },
                                    React.createElement('div', { style: { height: `${p1Pct}%` }, className: `${PLAYERS.player_1.barColor} w-full transition-all` }),
                                    React.createElement('div', { style: { height: `${p2Pct}%` }, className: `${PLAYERS.player_2.barColor} w-full transition-all border-b border-white/20` })
                                ),
                                React.createElement('div', { className: "mt-2 text-xl" }, data.emoji)
                            );
                        })
                    ),
                    stats.chartData.length > 0 && React.createElement('div', { className: "flex justify-center gap-4 mt-4 text-[10px] uppercase font-bold text-gray-400 dark:text-gray-500 tracking-widest" },
                        React.createElement('div', { className: "flex items-center gap-1" }, React.createElement('div', { className: `w-2 h-2 rounded-full ${PLAYERS.player_2.barColor}` }), " Beto"),
                        React.createElement('div', { className: "flex items-center gap-1" }, React.createElement('div', { className: `w-2 h-2 rounded-full ${PLAYERS.player_1.barColor}` }), " Maga")
                    )
                ),
                React.createElement('div', null,
                    React.createElement('h3', { className: "font-bold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2" }, React.createElement(Clock, { size: 18, className: "text-gray-500" }), " Historial Completo"),
                    React.createElement('div', { className: "space-y-4" },
                        history.map(day => {
                            const p1 = day.players?.player_1 || {};
                            const p2 = day.players?.player_2 || {};
                            const legacyGlobalTheme = day.theme_name;
                            // NUEVO: ICONO CHECK DE ESCUCHADO
                            const p1Listened = p1.status === 'escuchado';
                            const p2Listened = p2.status === 'escuchado';
                            
                            return React.createElement('div', { key: day.id, className: "bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-gray-200 dark:border-dark-border overflow-hidden" },
                                React.createElement('div', { className: "bg-gray-50/80 dark:bg-gray-800/50 p-3 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center" },
                                    React.createElement('span', { className: "text-xs font-bold text-gray-500 dark:text-gray-400" }, day.date),
                                    legacyGlobalTheme && React.createElement('span', { className: "text-xs bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-2 py-1 rounded-md font-bold truncate max-w-[150px]" }, legacyGlobalTheme)
                                ),
                                React.createElement('div', { className: "p-4 grid grid-cols-2 divide-x divide-gray-100 dark:divide-gray-700" },
                                    React.createElement('div', { className: "pr-3" },
                                        React.createElement('div', { className: "flex items-center gap-1 mb-1.5 justify-between" },
                                            React.createElement('p', { className: "text-xs font-extrabold text-pink-600 dark:text-pink-400 uppercase tracking-wider" }, "Maga"),
                                            p1Listened ? React.createElement(CheckCheck, {size: 14, className: "text-blue-500"}) : (p1.song_title && React.createElement(Check, {size: 14, className: "text-gray-300"}))
                                        ),
                                        p1.theme_name && React.createElement('p', { className: "text-[10px] text-gray-400 dark:text-gray-500 uppercase font-bold truncate mb-1" }, p1.theme_name),
                                        React.createElement('p', { className: "text-sm font-bold text-gray-800 dark:text-gray-200 truncate leading-snug font-body" }, p1.song_title || '-'),
                                        React.createElement('p', { className: "text-xs text-gray-500 dark:text-gray-400 truncate" }, p1.artist),
                                        p1.spotify_link && React.createElement('a', { href: p1.spotify_link, target: "_blank", rel: "noopener noreferrer", className: "inline-flex mt-1 text-green-500 hover:text-green-400" }, React.createElement(ExternalLink, { size: 12 }))
                                    ),
                                    React.createElement('div', { className: "pl-3" },
                                        React.createElement('div', { className: "flex items-center gap-1 mb-1.5 justify-between" },
                                            React.createElement('p', { className: "text-xs font-extrabold text-blue-600 dark:text-blue-400 uppercase tracking-wider" }, "Beto"),
                                            p2Listened ? React.createElement(CheckCheck, {size: 14, className: "text-blue-500"}) : (p2.song_title && React.createElement(Check, {size: 14, className: "text-gray-300"}))
                                        ),
                                        p2.theme_name && React.createElement('p', { className: "text-[10px] text-gray-400 dark:text-gray-500 uppercase font-bold truncate mb-1" }, p2.theme_name),
                                        React.createElement('p', { className: "text-sm font-bold text-gray-800 dark:text-gray-200 truncate leading-snug font-body" }, p2.song_title || '-'),
                                        React.createElement('p', { className: "text-xs text-gray-500 dark:text-gray-400 truncate" }, p2.artist),
                                        p2.spotify_link && React.createElement('a', { href: p2.spotify_link, target: "_blank", rel: "noopener noreferrer", className: "inline-flex mt-1 text-green-500 hover:text-green-400" }, React.createElement(ExternalLink, { size: 12 }))
                                    )
                                )
                            );
                        })
                    )
                )
            );
        };

        const AppWithData = () => {
             const [authUser, setAuthUser] = useState(null);
             const [userRole, setUserRole] = useState(() => localStorage.getItem('maga_beto_role'));
             const [currentScreen, setCurrentScreen] = useState('themes'); 
             
             const [themes, setThemes] = useState([]);
             const [todayEntry, setTodayEntry] = useState(null);
             const [stats, setStats] = useState(null);

             useEffect(() => {
                const init = async () => {
                    await signInAnonymously(auth);
                };
                init();
                
                // Check Dark Mode Preference
                const savedTheme = localStorage.getItem('mb_theme');
                if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }

                onAuthStateChanged(auth, setAuthUser);
            }, []);

            useEffect(() => {
                if (!authUser) return;
                const q = query(collection(db, 'daily_entries'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                     const data = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                     let totalMaga = 0, totalBeto = 0, listenedMaga = 0, listenedBeto = 0;
                     data.forEach(d => {
                         const p1 = d.players?.player_1, p2 = d.players?.player_2;
                         if (p1?.song_title) {
                             totalMaga++;
                             if (p1.status === 'escuchado') listenedBeto++; // Beto escuch√≥ a Maga
                         }
                         if (p2?.song_title) {
                             totalBeto++;
                             if (p2.status === 'escuchado') listenedMaga++; // Maga escuch√≥ a Beto
                         }
                     });
                     setStats({ totalMaga, totalBeto, listenedByMaga: listenedMaga, listenedByBeto: listenedBeto });
                });
                return () => unsubscribe();
            }, [authUser]);

            useEffect(() => {
                if (!authUser) return;

                const themesQuery = query(collection(db, 'themes'));
                const unsubThemes = onSnapshot(themesQuery, (snap) => {
                    const list = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    list.sort((a, b) => {
                        const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                        const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                        return dateB - dateA; 
                    });
                    setThemes(list);
                    if(list.length === 0) {
                        DEFAULT_THEMES.forEach(name => addDoc(collection(db, 'themes'), {name, active: true}));
                    }
                }, (error) => {
                    console.error("Error lectura:", error);
                    if (error.code === 'permission-denied') {
                        alert("¬°Error de Permisos! \n\nNo has configurado las Reglas de Firebase.");
                    }
                });

                const todayId = getTodayString();
                const todayRef = doc(db, 'daily_entries', todayId);
                const unsubToday = onSnapshot(todayRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setTodayEntry({id: docSnap.id, ...docSnap.data()});
                    } else {
                        setTodayEntry(null);
                    }
                });

                return () => {
                    unsubThemes();
                    unsubToday();
                };
            }, [authUser]);

            // Process themes: Selected FIRST, then by total usage (Maga + Beto) DESC
            const processedThemes = React.useMemo(() => {
                const selectedId = todayEntry?.players?.[userRole]?.theme_id;
                
                return themes.map(t => ({
                    ...t,
                    isSelected: t.id === selectedId
                })).sort((a, b) => {
                    if (a.isSelected && !b.isSelected) return -1;
                    if (!a.isSelected && b.isSelected) return 1;
                    
                    const totalA = (a.usage_player_1 || 0) + (a.usage_player_2 || 0);
                    const totalB = (b.usage_player_1 || 0) + (b.usage_player_2 || 0);
                    if (totalB !== totalA) return totalB - totalA;

                    const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                    const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                    if (dateB !== dateA) return dateB - dateA;
                    
                    return a.name.localeCompare(b.name);
                });
            }, [themes, todayEntry, userRole]);

            const handleSelectTheme = async (theme, isRandom = false) => {
                const todayId = getTodayString();
                const currentStatus = todayEntry?.players?.[userRole]?.status;
                
                if (currentStatus === 'enviado' || currentStatus === 'escuchado') {
                    if (!confirm("¬øSeguro que quieres cambiar la tem√°tica? Tu canci√≥n se mantendr√°, pero cambiar√° el contexto.")) {
                        return;
                    }
                }
                
                let selectedTheme = theme;
                if (isRandom) {
                    const activeThemes = themes.filter(t => t.active);
                    if(activeThemes.length === 0) return;
                    selectedTheme = activeThemes[Math.floor(Math.random() * activeThemes.length)];
                }
                await setDoc(doc(db, 'daily_entries', todayId), {
                    date: todayId,
                    players: {
                        [userRole]: { theme_id: selectedTheme.id, theme_name: selectedTheme.name, status: currentStatus || 'pendiente' } 
                    }
                }, { merge: true });

                setCurrentScreen('today');
            };
            
            const handleAddTheme = async (name) => {
                await addDoc(collection(db, 'themes'), { 
                    name, 
                    active: true,
                    createdAt: new Date().toISOString() 
                });
            };

            const handleToggleTheme = async (id, newState) => {
                await updateDoc(doc(db, 'themes', id), { active: newState });
            };

            const handleDeselectTheme = async () => {
                if (!confirm("¬øQuieres cambiar de tem√°tica? Se borrar√° la selecci√≥n actual.")) return;
                
                const todayId = getTodayString();
                await updateDoc(doc(db, 'daily_entries', todayId), {
                    [`players.${userRole}.theme_id`]: deleteField(),
                    [`players.${userRole}.theme_name`]: deleteField(),
                });
                
                setCurrentScreen('themes');
            };

            // Reparar Contadores y MIGRACI√ìN DE ESTADO ESCUCHADO
            const handleFixCounters = async () => {
                if (!confirm("¬øSeguro que quieres recalcular los contadores y actualizar el historial antiguo?")) return;
                try {
                    const batch = writeBatch(db);
                    const entriesSnap = await getDocs(collection(db, 'daily_entries'));
                    const themesSnap = await getDocs(collection(db, 'themes'));
                    
                    // 1. Migraci√≥n Masiva: Marcar canciones antiguas como escuchadas
                    entriesSnap.docs.forEach(doc => {
                        const data = doc.data();
                        const p1 = data.players?.player_1;
                        const p2 = data.players?.player_2;
                        
                        // Si Maga envi√≥ canci√≥n y no est√° marcada, marcarla (para que Beto tenga el check)
                        if (p1?.song_title && p1.status !== 'escuchado') {
                            batch.update(doc.ref, { [`players.player_1.status`]: 'escuchado' });
                        }
                        // Si Beto envi√≥ canci√≥n y no est√° marcada
                        if (p2?.song_title && p2.status !== 'escuchado') {
                            batch.update(doc.ref, { [`players.player_2.status`]: 'escuchado' });
                        }
                    });

                    // 2. Rec√°lculo de temas (igual que antes)
                    const realCounts = {};
                    entriesSnap.docs.forEach(doc => {
                        const data = doc.data();
                        const p1 = data.players?.player_1;
                        const p2 = data.players?.player_2;
                        if (p1?.theme_id && p1.song_title) {
                            if (!realCounts[p1.theme_id]) realCounts[p1.theme_id] = { p1: 0, p2: 0 };
                            realCounts[p1.theme_id].p1++;
                        }
                        if (p2?.theme_id && p2.song_title) {
                            if (!realCounts[p2.theme_id]) realCounts[p2.theme_id] = { p1: 0, p2: 0 };
                            realCounts[p2.theme_id].p2++;
                        }
                    });
                    themesSnap.docs.forEach(themeDoc => {
                        const counts = realCounts[themeDoc.id] || { p1: 0, p2: 0 };
                        batch.update(themeDoc.ref, { usage_player_1: counts.p1, usage_player_2: counts.p2 });
                    });

                    await batch.commit();
                    alert("¬°Todo actualizado! Canciones marcadas como escuchadas y contadores reparados.");
                } catch (e) { console.error(e); alert("Error: " + e.message); }
            };

            const handleSongSubmit = async (data) => {
                const todayId = getTodayString();
                const currentPlayerData = todayEntry?.players?.[userRole] || {};
                const isFirstSend = !currentPlayerData.song_title; 
                
                await updateDoc(doc(db, 'daily_entries', todayId), {
                    [`players.${userRole}.song_title`]: data.song_title,
                    [`players.${userRole}.artist`]: data.artist,
                    [`players.${userRole}.comment`]: data.comment,
                    [`players.${userRole}.status`]: 'enviado',
                    [`players.${userRole}.spotify_link`]: data.spotify_link
                });

                if (isFirstSend && currentPlayerData.theme_id) {
                    const themeRef = doc(db, 'themes', currentPlayerData.theme_id);
                    await updateDoc(themeRef, { [`usage_${userRole}`]: increment(1) });
                }
            };

            const handleUpdateEntry = async (updates) => {
                const todayId = getTodayString();
                await updateDoc(doc(db, 'daily_entries', todayId), updates);
            };

            if (!userRole) return React.createElement(LoginScreen, { onLogin: (role) => { setUserRole(role); localStorage.setItem('maga_beto_role', role); } });

            return React.createElement('div', { className: "h-[100dvh] w-full bg-[#f8fafc] text-gray-800 font-sans fixed inset-0 overflow-hidden flex flex-col dark:bg-dark-bg dark:text-dark-text" },
                React.createElement(InstallPrompt),
                
                React.createElement(PullToRefresh, {},
                    React.createElement('div', { className: "max-w-md mx-auto min-h-full bg-white/50 sm:shadow-2xl sm:border-x sm:border-gray-100 dark:bg-dark-bg dark:border-gray-800" },
                       currentScreen === 'themes' ? React.createElement(ThemesScreen, { themes: processedThemes, onSelectTheme: handleSelectTheme, onAddTheme: handleAddTheme, onToggleTheme: handleToggleTheme, userRole }) :
                       currentScreen === 'today' ? React.createElement(TodayScreen, { entry: todayEntry, userRole, onUpdateEntry: handleUpdateEntry, onSongSubmit: handleSongSubmit, onDeselectTheme: handleDeselectTheme }) :
                       currentScreen === 'stats' ? React.createElement(StatsScreen, { userId: authUser?.uid }) :
                       React.createElement(ProfileScreen, { userRole, onLogout: () => { setUserRole(null); localStorage.removeItem('maga_beto_role'); }, onFixCounters: handleFixCounters, stats, userId: authUser?.uid }) 
                    )
                ),

                React.createElement('nav', { className: "bg-white/90 dark:bg-dark-card/90 backdrop-blur-md border-t border-gray-200 dark:border-dark-border flex justify-around py-3 px-4 z-50 pb-[env(safe-area-inset-bottom,20px)] sm:pb-3 max-w-md mx-auto w-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]" },
                    ['themes', 'today', 'stats', 'home'].map(screen => // ORDEN: Temas - Hoy - Resumen - Perfil
                        React.createElement('button', { 
                            key: screen,
                            onClick: () => setCurrentScreen(screen),
                            className: `flex flex-col items-center gap-1 active:scale-90 transition-transform p-2 rounded-xl ${currentScreen === screen ? 'text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30' : 'text-gray-400 dark:text-gray-500'}`
                        }, 
                        React.createElement(screen === 'home' ? User : screen === 'today' ? Music : screen === 'themes' ? Library : BarChart3, { size: 22, strokeWidth: currentScreen === screen ? 2.5 : 2 }),
                        React.createElement('span', { className: "text-[10px] font-bold tracking-wide uppercase" }, screen === 'stats' ? 'Resumen' : screen === 'home' ? 'Perfil' : screen === 'today' ? 'Hoy' : 'Temas')
                        )
                    )
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(AppWithData));
    </script>
</body>
</html>
